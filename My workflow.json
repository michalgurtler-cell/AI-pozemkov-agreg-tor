{
  "name": "My workflow",
  "nodes": [
    {
      "parameters": {
        "promptType": "define",
        "text": "=Jsi expert na nemovitostn√≠ pr√°vo a investiƒçn√≠ analytik specializovan√Ω na ƒçesk√Ω trh s pozemky. Tv√Ωm √∫kolem je prov√©st hloubkovou extrakci dat z inzer√°tu a ve≈ôejn√Ωch registr≈Ø a p≈ôipravit podklady pro investiƒçn√≠ rating.\n\nVSTUPN√ç DATA\nID Inzer√°tu: {{ $json.hash_id }}\n\nURL Sreality: {{ $json.url_sreality }}\n\nGPS ArcGIS: {{ $json.gps_arcgis }}\n\nLokalita z inzer√°tu: {{ $json.lokalita_inzerat }}\n\nCena z inzer√°tu: {{ $json.cena_inzerat }} Kƒç\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nINSTRUKCE PRO ZPRACOV√ÅN√ç (LOGICK√ù PR≈ÆCHOD)\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nKROK 1: IDENTIFIKACE PARCEL (Sreality Mining)\nZ√≠skej z URL Sreality: V√Ωmƒõru v m¬≤, typ pozemku (stavebn√≠, orn√° p≈Øda, atd.).\n\nHloubkov√Ω mining v textu: Identifikuj V≈†ECHNA parceln√≠ ƒç√≠sla (nap≈ô. p.ƒç. 123/1) a ƒç√≠sla List≈Ø vlastnictv√≠ (LV).\n\nZ√ÅKLADN√ç PRAVIDLO: Pokud inzer√°t obsahuje v√≠ce parcel, mus√≠≈° pro KA≈ΩDOU parcelu vytvo≈ôit samostatn√Ω objekt (≈ô√°dek) ve v√Ωstupu. Ne≈ôe≈° duplicity v r√°mci inzer√°tu, ale extrahuj detail pro ka≈æd√Ω prvek zvl√°≈°≈•.\n\nKROK 2: PR√ÅVN√ç A TECHNICK√ù AUDIT (R√öIAN & KN)\nPro ka≈ædou identifikovanou parcelu zjisti (nebo vyvoƒè z dostupn√Ωch dat):\n\nKatastr√°ln√≠ √∫zem√≠ (K√ö): N√°zev a K√≥d K√ö (vyu≈æij vdp.cuzk.gov.cz).\n\nPr√°vn√≠ vady (KO Faktory): Hledej v textu zm√≠nky o exekuci, insolvenci nebo vƒõcn√Ωch b≈ôemenech (nap≈ô. \"ch≈Øze a j√≠zdy\").\n\nZas√≠≈•ov√°n√≠ (TEA Atributy): Z Registru R√öIAN zjisti technickoekonomick√© atributy staveb na pozemku nebo zm√≠nky v textu o p≈ôipojen√≠ (Plyn, Kanalizace, Vodovodn√≠ ≈ôad).\n\nKROK 3: BONITA P≈ÆDY A OCHRANA ZPF (BPEJ)\nVolej/analyzuj eKatalog BPEJ (bpej.vumop.cz) a dek√≥duj 5m√≠stn√Ω k√≥d:\n\nT≈ô√≠da ochrany ZPF: I-V (Kritick√© pro ≈°anci na zastavƒõn√≠: I-II = t√©mƒõ≈ô nezastaviteln√©, IV-V = ide√°ln√≠ pro development).\n\nBodov√° v√Ωnosnost: 6‚Äì100 (produkƒçn√≠ schopnost p≈Ødy).\n\nSklonitost: Z 4. ƒç√≠slice k√≥du (0 = rovina, 5+ = svah, riziko eroze).\n\nKROK 4: RIZIKA A LIMITY (Floods & AOPK)\nPovod≈àov√© riziko (ƒåAP): Urƒçi z√≥nu 1 (bezpeƒç√≠) a≈æ 4 (nepojistiteln√©, nezastaviteln√©).\n\nOchrana p≈ô√≠rody (AOPK): Zjisti pr≈Ønik s CHKO, NP, Natura 2000 nebo biocentry (√öSES).\n\nTechnick√© mapy (DTM): Ovƒõ≈ô existenci dopravn√≠ a technick√© infrastruktury (p≈ôes dmvs.cuzk.gov.cz).\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nV√ùPOƒåET INVESTIƒåN√çHO RATINGU (Metodika)\nKe ka≈æd√© parcele p≈ôi≈ôaƒè sk√≥re 0‚Äì100 bod≈Ø na z√°kladƒõ tƒõchto vah:\n\nSoulad s √öP (35 %): Stavebn√≠ = 100, Rezerva/N√°vrh = 50, Nezastaviteln√© = 0.\n\nZas√≠≈•ov√°n√≠ (20 %): Kompletn√≠ s√≠tƒõ = 100, Mo≈ænost napojen√≠ = 50, Bez s√≠t√≠ = 0.\n\nBonita/ZPF (15 %): T≈ô√≠da IV-V = 100, III = 50, I-II = 0.\n\nEnvironment√°ln√≠ rizika (20 %): Povod≈àov√° z√≥na 1 + mimo CHKO = 100, Z√≥na 4 = 0.\n\nCenov√° v√Ωhodnost (10 %): Srovn√°n√≠ nab√≠dkov√© ceny s pr≈Ømƒõrem v K√ö.\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nPO≈ΩADOVAN√ù V√ùSTUP (Ploch√Ω JSON pro Sheets)\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê V√Ωstupem mus√≠ b√Ωt POLE objekt≈Ø (Array of Objects), kde ka≈æd√Ω objekt p≈ôedstavuje jednu parcelu.",
        "options": {
          "systemMessage": "Jsi datov√Ω agent pro anal√Ωzu ƒçesk√Ωch pozemk≈Ø.\n\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n‚ïë  üî¥ KRITICK√â PRAVIDLO: PARCELY POUZE Z INZER√ÅTU!                        ‚ïë\n‚ïë                                                                          ‚ïë\n‚ïë  GPS slou≈æ√≠ POUZE k identifikaci katastr√°ln√≠ho √∫zem√≠ a BPEJ.            ‚ïë\n‚ïë  NIKDY nestahuj v≈°echny parcely v okol√≠ GPS!                            ‚ïë\n‚ïë                                                                          ‚ïë\n‚ïë  Parcely a LV extrahuj V√ùHRADNƒö z textu popisu na Sreality.             ‚ïë\n‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n\nPOSTUP:\n1. Zavolej Sreality API ‚Üí d≈Økladnƒõ p≈ôeƒçti POPIS inzer√°tu\n2. V popisu HLEDEJ: LV, parcela, p.ƒç., elekt≈ôina, voda, plyn, kanalizace\n3. Zavolej BPEJ API ‚Üí z√≠skej kvalitu p≈Ødy\n4. Zavolej R√öIAN K√ö API ‚Üí z√≠skej POUZE katastr√°ln√≠ √∫zem√≠ (NE parcely!)\n\nP≈ò√çKLADY EXTRAKCE Z POPISU:\n- \"Prodej pozemku p.ƒç. 1234/5\" ‚Üí parcely: \"1234/5\"\n- \"LV 789\" ‚Üí listy_vlastnictvi: \"789\"\n- \"elekt≈ôina na hranici pozemku\" ‚Üí site_elektrina: \"na hranici\"\n- \"k.√∫. Horn√≠ Lhota\" ‚Üí katastralni_uzemi: \"Horn√≠ Lhota\"\n\nPokud inzer√°t NEUV√ÅD√ç parcelu nebo LV:\n- parcely: \"neuvedeno v inzer√°tu\"\n- listy_vlastnictvi: \"neuvedeno v inzer√°tu\"\n- vymera_ruian_m2: \"\" (pr√°zdn√©, proto≈æe nem√°≈° konkr√©tn√≠ parcelu)\n\nV√Ωstup MUS√ç b√Ωt ƒçist√Ω JSON bez markdown.",
          "maxIterations": 10
        }
      },
      "id": "eac24a0e-ed18-466b-a518-e76d6fce92a9",
      "name": "üèûÔ∏è AI BATCH Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        0,
        0
      ]
    },
    {
      "parameters": {
        "jsCode": "// BATCH PARSER v6\nconst input = $input.first().json;\nconst loopItem = $('üîÑ Pozemek Loop').first().json;\nlet results = [];\n\ntry {\n  let text = input.output || input.text || input.response || '';\n  if (typeof text !== 'string') text = JSON.stringify(text);\n\n  text = text.replace(/```json\\s*/gi, '').replace(/```\\s*/gi, '').trim();\n\n  const arrayMatch = text.match(/\\[[\\s\\S]*\\]/);\n  if (arrayMatch) {\n    results = JSON.parse(arrayMatch[0]);\n  } else {\n    const objMatch = text.match(/\\{[\\s\\S]*\\}/);\n    if (objMatch) results = [JSON.parse(objMatch[0])];\n  }\n} catch (e) {\n  console.log('Parse error:', e.message);\n}\n\n// FALLBACK\nif (!results || results.length === 0) {\n  results = [{\n    id_hash: loopItem.hash_id || '',\n    nazev: loopItem.nazev_inzerat || '',\n    lokalita: loopItem.lokalita_inzerat || '',\n    cena_czk: loopItem.cena_inzerat || 0,\n    vymera_inzerat_m2: 0,\n    vymera_ruian_m2: '',\n    kontrola_vymery: '',\n    gps_lon_lat: loopItem.gps_arcgis || '',\n    parcely: 'neuvedeno',\n    pocet_parcel: '',\n    katastralni_uzemi: '',\n    listy_vlastnictvi: 'neuvedeno',\n    druh_pozemku: '',\n    zpusob_vyuziti: '',\n    bpej: '',\n    trida_zpf: '',\n    popis_pudy: '',\n    site_elektrina: '',\n    site_voda: '',\n    site_kanalizace: '',\n    site_plyn: '',\n    zdroje_dat: 'FALLBACK',\n    poznamka: 'AI nevr√°til data'\n  }];\n}\n\nreturn results.map(d => {\n  const vymeraInz = parseInt(d.vymera_inzerat_m2) || 0;\n  const vymeraRuian = parseInt(d.vymera_ruian_m2) || '';\n  const cena = parseInt(d.cena_czk) || 0;\n  const cenaM2 = vymeraInz > 0 && cena > 0 ? Math.round(cena / vymeraInz) : '';\n\n  return {\n    json: {\n      'ID [hash]': d.id_hash ? `sr_${d.id_hash}` : '',\n      'N√°zev [Sreality]': d.nazev || '',\n      'Lokalita': d.lokalita || '',\n      'Cena [Kƒç]': cena || '',\n      'V√Ωmƒõra ‚Äì inzer√°t [m¬≤]': vymeraInz || '',\n      'V√Ωmƒõra ‚Äì R√öIAN [m¬≤]': vymeraRuian,\n      'Cena/m¬≤ [Kƒç]': cenaM2,\n      'GPS [LON,LAT]': d.gps_lon_lat || '',\n      'Parcely': d.parcely || '',\n      'Poƒçet parcel': d.pocet_parcel || '',\n      'Katastr√°ln√≠ √∫zem√≠': d.katastralni_uzemi || '',\n      'Listy vlastnictv√≠': d.listy_vlastnictvi || '',\n      'Druh pozemku [R√öIAN]': d.druh_pozemku || '',\n      'Zp≈Øsob vyu≈æit√≠ [R√öIAN]': d.zpusob_vyuziti || '',\n      'Kontrola v√Ωmƒõry': d.kontrola_vymery || '',\n      'BPEJ': d.bpej || '',\n      'T≈ô√≠da ZPF': d.trida_zpf || '',\n      'Popis p≈Ødy': d.popis_pudy || '',\n      'S√≠tƒõ ‚Äì elekt≈ôina': d.site_elektrina || '',\n      'S√≠tƒõ ‚Äì voda': d.site_voda || '',\n      'S√≠tƒõ ‚Äì kanalizace': d.site_kanalizace || '',\n      'S√≠tƒõ ‚Äì plyn': d.site_plyn || '',\n      'Zdroje dat': d.zdroje_dat || '',\n      'Pozn√°mka': d.poznamka || '',\n      'Odkaz [Sreality]': d.id_hash ? `https://www.sreality.cz/detail/prodej/pozemek/bydleni/x/${d.id_hash}` : '',\n      'Datum [syst√©m]': new Date().toISOString().split('T')[0]\n    }\n  };\n});"
      },
      "id": "bf59fab7-6d07-4aee-83ee-4cc7bd5bcd08",
      "name": "üìä BATCH Parser",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        352,
        112
      ]
    },
    {
      "parameters": {
        "projectId": {
          "__rl": true,
          "mode": "list",
          "value": "gen-lang-client-0737675877"
        },
        "modelName": "gemini-2.0-flash",
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleVertex",
      "typeVersion": 1,
      "position": [
        16,
        224
      ],
      "id": "991c7a32-8f2e-4e90-a07f-91789cbc3038",
      "name": "Google Vertex Chat Model1",
      "credentials": {
        "googleApi": {
          "id": "KGzAAuQ37otupHhs",
          "name": "Google Service Account account"
        }
      }
    },
    {
      "parameters": {
        "toolDescription": "HTTP GET pro vol√°n√≠ API.\n\nüî¥ POU≈ΩIJ P≈òESNOU URL KTEROU DOSTANE≈†!\n\nTypy URL:\n1. Sreality detail: https://www.sreality.cz/api/cs/v2/estates/{hash_id}\n2. BPEJ (kvalita p≈Ødy): https://services-eu1.arcgis.com/.../BPEJ.../query?...\n3. R√öIAN K√ö (katastr√°ln√≠ √∫zem√≠): https://ags.cuzk.cz/.../query?...\n\n‚ö†Ô∏è NIKDY nepou≈æ√≠vej pro hromadn√© stahov√°n√≠ parcel!\nGPS v URL slou≈æ√≠ POUZE k identifikaci lokality, NE k seznamu parcel.",
        "url": "={url}",
        "placeholderDefinitions": {
          "values": [
            {
              "name": "url",
              "description": "Kompletn√≠ URL - pou≈æij p≈ôesnƒõ jak je, NEMƒö≈á JI",
              "type": "string"
            }
          ]
        },
        "optimizeResponse": true
      },
      "id": "1af14c38-fe20-4c5e-87af-9ae64b573fb1",
      "name": "http_api_request1",
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1.1,
      "position": [
        144,
        224
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "üèûÔ∏è AI BATCH Agent": {
      "main": [
        [
          {
            "node": "üìä BATCH Parser",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Vertex Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "üèûÔ∏è AI BATCH Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "http_api_request1": {
      "ai_tool": [
        [
          {
            "node": "üèûÔ∏è AI BATCH Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "273e05c8-e353-450f-b810-9c3ecf580106",
  "meta": {
    "instanceId": "8e34adb2300e52401f1c93ba0ab7517532d8d52d13b15ba3aac6a6f9125919c4"
  },
  "id": "RGWY2gTCWqHd5XjCxjulq",
  "tags": []
}
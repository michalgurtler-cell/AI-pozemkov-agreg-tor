{
  "name": "Data Aggregator v6 OPRAVENÃ",
  "nodes": [
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DATA AGGREGATOR v10 - S DETEKCÃ POZEMKÅ® BEZ BPEJ\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// Opravy v10:\n// - Detekce pozemkÅ¯ kterÃ© NEMAJÃ BPEJ (les, vodnÃ­ plocha, zastavÄ›nÃ¡, ostatnÃ­)\n// - Flag bpej_neni_relevantni pro AI\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst DRUHY_POZEMKU = {\n  2: 'ornÃ¡ pÅ¯da', 3: 'chmelnice', 4: 'vinice', 5: 'zahrada',\n  6: 'ovocnÃ½ sad', 7: 'trvalÃ½ travnÃ­ porost', 10: 'lesnÃ­ pozemek',\n  11: 'vodnÃ­ plocha', 13: 'zastavÄ›nÃ¡ plocha', 14: 'ostatnÃ­ plocha'\n};\n\nconst ZPUSOBY_VYUZITI = {\n  1: 'sklenÃ­k', 2: 'Å¡kolka', 5: 'zeleÅˆ', 6: 'rybnÃ­k', 7: 'zamokÅ™enÃ¡ plocha',\n  10: 'spoleÄnÃ½ dvÅ¯r', 11: 'zboÅ™eniÅ¡tÄ›', 14: 'sklÃ¡dka',\n  18: 'komunikace', 23: 'silnice', 24: 'ostatnÃ­ komunikace', 25: 'neplodnÃ¡ pÅ¯da'\n};\n\nconst BPEJ_TRIDY = {\n  '01':'I','02':'I','03':'I','04':'I','05':'I','06':'I','07':'I','08':'I','09':'I','10':'I','11':'I','12':'I','13':'I',\n  '14':'II','15':'II','16':'II','17':'II','18':'II','19':'II','20':'II','21':'II','22':'II','23':'II','24':'II','25':'II',\n  '26':'III','27':'III','28':'III','29':'III','30':'III','31':'III','32':'III','33':'III','34':'III','35':'III','36':'III','37':'III','38':'III','39':'III','40':'III',\n  '41':'IV','42':'IV','43':'IV','44':'IV','45':'IV','46':'IV','47':'IV','48':'IV','49':'IV','50':'IV','51':'IV','52':'IV','53':'IV','54':'IV','55':'IV','56':'IV','57':'IV','58':'IV',\n  '59':'V','60':'V','61':'V','62':'V','63':'V','64':'V','65':'V','66':'V','67':'V','68':'V','69':'V','70':'V','71':'V','72':'V','73':'V','74':'V','75':'V','76':'V','77':'V','78':'V'\n};\n\n// Druhy pozemkÅ¯ kterÃ© NEMAJÃ BPEJ (nejsou zemÄ›dÄ›lskÃ¡ pÅ¯da)\nconst DRUHY_BEZ_BPEJ = [10, 11, 13, 14]; // les, vodnÃ­ plocha, zastavÄ›nÃ¡, ostatnÃ­\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// NAÄŒTENÃ DAT Z NODÅ®\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nlet priprava = {};\nlet ruianKu = {};\nlet parcelyExtractor = {};\nlet bpejData = {};\nlet pvgisData = {};\n\ntry { \n  priprava = $('PÅ™Ã­prava pro API').item.json; \n  console.log('âœ“ PÅ™Ã­prava pro API naÄtena');\n} catch(e) { \n  console.log('âœ— PÅ™Ã­prava pro API err:', e.message); \n}\n\ntry { \n  ruianKu = $('ğŸ—ºï¸ RÃšIAN KÃš HTTP').item.json; \n  console.log('âœ“ RÃšIAN KÃš naÄten, features:', ruianKu?.features?.length || 0);\n} catch(e) { \n  console.log('âœ— RÃšIAN KÃš err:', e.message); \n}\n\ntry { \n  parcelyExtractor = $('ğŸ“ Parcela GPS Extractor').item.json; \n  console.log('âœ“ Parcela GPS Extractor, features:', parcelyExtractor?.features?.length || 0);\n} catch(e) { \n  try {\n    parcelyExtractor = $('ğŸ—ºï¸ RÃšIAN Parcely HTTP').item.json;\n    console.log('âœ“ RÃšIAN Parcely HTTP (fallback), features:', parcelyExtractor?.features?.length || 0);\n  } catch(e2) {\n    console.log('âœ— Parcely err:', e2.message); \n  }\n}\n\ntry { \n  bpejData = $('ğŸŒ¾ BPEJ HTTP').item.json; \n  console.log('âœ“ BPEJ naÄten, features:', bpejData?.features?.length || 0);\n} catch(e) { \n  console.log('âœ— BPEJ err:', e.message); \n}\n\ntry { \n  pvgisData = $('â˜€ï¸ PVGIS HTTP').item.json; \n  console.log('âœ“ PVGIS naÄten, outputs:', pvgisData?.outputs ? 'OK' : 'CHYBÃ');\n} catch(e) { \n  console.log('âœ— PVGIS err:', e.message); \n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ZÃKLADNÃ INFO\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst hashId = priprava.hash_id || '';\nconst nazev = priprava.nazev || '';\nconst popis = priprava.popis || '';\nconst cena = priprava.cena || 0;\nconst lokalita = priprava.lokalita || '';\nconst url = priprava.url || ('https://www.sreality.cz/detail/prodej/pozemek/bydleni/x/' + hashId);\nconst vymeraInzerat = priprava.vymera_inzerat || 0;\nconst maPresneUdaje = priprava.ma_presne_udaje || false;\n\n// Parcely z textu (z Detail Parseru)\nconst parcelyZTextu = priprava.parcely_z_textu || [];\nconst lvZTextu = priprava.lv_z_textu || null;\nconst kuZTextu = priprava.ku_z_textu || null;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// KÃš Z RÃšIAN\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nlet kuNazev = '';\nlet kuKod = '';\nif (ruianKu && ruianKu.features && ruianKu.features.length > 0) {\n  const f = ruianKu.features[0].attributes || ruianKu.features[0];\n  kuNazev = f.nazev || '';\n  kuKod = String(f.kod || '');\n}\n\n// Fallback na KÃš z textu\nif (!kuNazev && kuZTextu) {\n  kuNazev = kuZTextu;\n  console.log('  âš ï¸ KÃš nÃ¡zev z textu:', kuNazev);\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// PARCELY Z RÃšIAN (nebo z textu jako fallback)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst vsechnyParcely = [];\nlet celkovaVymera = 0;\nlet gpsParcela = parcelyExtractor.gps_parcela || '';\n\nif (parcelyExtractor && parcelyExtractor.features && parcelyExtractor.features.length > 0) {\n  for (let i = 0; i < parcelyExtractor.features.length; i++) {\n    const feat = parcelyExtractor.features[i];\n    const f = feat.attributes || feat;\n    const vymera = parseInt(f.vymeraparcely) || 0;\n    \n    vsechnyParcely.push({\n      cislo: f.cisloparcely || '-',\n      vymera: vymera,\n      druhKod: f.druhpozemkukod,\n      druh: DRUHY_POZEMKU[f.druhpozemkukod] || '-',\n      zpusobKod: f.zpusobyvyuzitipozemku,\n      zpusob: ZPUSOBY_VYUZITI[f.zpusobyvyuzitipozemku] || '-'\n    });\n    \n    celkovaVymera += vymera;\n    \n    if (i === 0 && !gpsParcela && feat.geometry && feat.geometry.rings && feat.geometry.rings[0]) {\n      const ring = feat.geometry.rings[0][0];\n      gpsParcela = ring[0] + ',' + ring[1];\n    }\n  }\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// FALLBACK: Parcely z textu pokud RÃšIAN nevrÃ¡til\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nlet parcelyText = '';\nlet druhPozemkuText = '-';\nlet hlavniDruhKod = 0;\n\nif (vsechnyParcely.length > 0) {\n  // MÃ¡me parcely z RÃšIAN\n  hlavniDruhKod = vsechnyParcely[0].druhKod || 0;\n  \n  parcelyText = vsechnyParcely.map(p => {\n    let t = p.cislo;\n    if (p.druh !== '-') t += ' (' + p.druh + ')';\n    if (p.vymera > 0) t += ' ' + p.vymera.toLocaleString('cs-CZ') + 'mÂ²';\n    return t;\n  }).join(' | ');\n  \n  const druhySet = [...new Set(vsechnyParcely.map(p => p.druh).filter(d => d !== '-'))];\n  druhPozemkuText = druhySet.join(', ') || '-';\n  \n} else if (parcelyZTextu.length > 0) {\n  // Fallback na parcely z textu\n  parcelyText = parcelyZTextu.join(', ');\n  console.log('  âš ï¸ Parcely z textu (RÃšIAN prÃ¡zdnÃ½):', parcelyText);\n  \n  // Zkusit extrahovat druh z popisu\n  const druhMatch = popis.match(/\\(([Oo]rnÃ¡ pÅ¯da|[Zz]ahrada|[Ll]es|[Ll]ouka|[Ss]tavebnÃ­|[Vv]odnÃ­)\\)/i);\n  if (druhMatch) {\n    druhPozemkuText = druhMatch[1].toLowerCase();\n    console.log('  âš ï¸ Druh z textu:', druhPozemkuText);\n  }\n}\n\nif (!parcelyText) {\n  parcelyText = '-';\n}\n\nconst zpusobySet = [...new Set(vsechnyParcely.map(p => p.zpusob).filter(z => z !== '-'))];\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// BPEJ - S DETEKCÃ POZEMKÅ® BEZ BPEJ\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nlet bpej = { kod: '', trida: '', sklon: '', expozice: '', popis: '' };\nlet bpejNeniRelevantni = false;\n\nif (DRUHY_BEZ_BPEJ.includes(hlavniDruhKod)) {\n  // Tento typ pozemku NEMÃ BPEJ - nenÃ­ zemÄ›dÄ›lskÃ¡ pÅ¯da\n  bpej.kod = 'NEMÃ (nenÃ­ ZPF)';\n  bpejNeniRelevantni = true;\n  console.log('  â„¹ï¸ Druh pozemku', hlavniDruhKod, '(' + DRUHY_POZEMKU[hlavniDruhKod] + ') - BPEJ nenÃ­ relevantnÃ­');\n} else if (bpejData && bpejData.features && bpejData.features.length > 0) {\n  const f = bpejData.features[0].attributes || bpejData.features[0];\n  const kod = f.BPEJ || f.KOD_BPEJ || '';\n  \n  if (kod && String(kod).length >= 5) {\n    const kodStr = String(kod).replace(/\\./g, '');\n    bpej.kod = String(kod);\n    \n    const hpj = kodStr.substring(1, 3);\n    bpej.trida = BPEJ_TRIDY[hpj] || 'V';\n    \n    const sklonKod = parseInt(kodStr.substring(3, 4));\n    const sklony = ['rovina 0-3Â°', 'mÃ­rnÃ½ 3-7Â°', 'stÅ™ednÃ­ 7-12Â°', 'vÃ½raznÃ½ 12-17Â°', 'prudkÃ½ >17Â°'];\n    bpej.sklon = sklony[sklonKod] || '-';\n    \n    const expoKod = parseInt(kodStr.substring(4, 5));\n    const expozice = ['rovina', 'J', 'JZ/JV', 'Z/V', 'SZ/SV', 'S'];\n    bpej.expozice = expozice[expoKod] || '-';\n    \n    // PouÅ¾Ã­t TO_ZPF pokud je dostupnÃ©\n    if (f.TO_ZPF) {\n      bpej.trida = f.TO_ZPF;\n    }\n    \n    bpej.popis = f.PT_NAZEV || '';\n  }\n} else {\n  bpej.kod = 'NENÃ V LPIS';\n  \n  // Pokud je ornÃ¡ pÅ¯da ale nenÃ­ v LPIS - divnÃ©\n  if (druhPozemkuText.includes('ornÃ¡')) {\n    console.log('  âš ï¸ OrnÃ¡ pÅ¯da ale NENÃ V LPIS - zkontrolovat GPS!');\n  }\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// PVGIS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nlet pvgis = { vyroba: 0, ozareni: 0, sklon: 0, azimut: 0 };\nif (pvgisData && pvgisData.outputs && pvgisData.outputs.totals && pvgisData.outputs.totals.fixed) {\n  const t = pvgisData.outputs.totals.fixed;\n  pvgis.vyroba = Math.round(t.E_y || 0);\n  pvgis.ozareni = Math.round(t.H_year || 0);\n  if (pvgisData.inputs && pvgisData.inputs.mounting_system && pvgisData.inputs.mounting_system.fixed) {\n    pvgis.sklon = pvgisData.inputs.mounting_system.fixed.slope || 0;\n    pvgis.azimut = pvgisData.inputs.mounting_system.fixed.azimuth || 0;\n  }\n} else {\n  console.log('  âš ï¸ PVGIS nevrÃ¡til data');\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// KVALITA DAT\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst maParcely = vsechnyParcely.length > 0 || parcelyZTextu.length > 0;\nconst maVymeru = celkovaVymera > 0;\nconst maBpej = bpej.kod && bpej.kod !== 'NENÃ V LPIS' && bpej.kod !== 'NEMÃ (nenÃ­ ZPF)';\nconst maKu = kuKod !== '';\n\nlet dataKvalita = 'D_GPS_ONLY';\nlet zdrojDat = [];\n\nif (maPresneUdaje && vsechnyParcely.length > 0 && maVymeru && maKu) {\n  dataKvalita = 'A_PARCELY_PRESNE';\n  zdrojDat.push('RÃšIAN (parcely)');\n} else if (vsechnyParcely.length > 0 && maVymeru && maKu) {\n  dataKvalita = 'B_GPS_PARCELA';\n  zdrojDat.push('RÃšIAN (GPS)');\n} else if (parcelyZTextu.length > 0) {\n  dataKvalita = 'B_INZERAT_PARCELA';\n  zdrojDat.push('InzerÃ¡t (parcely)');\n} else if (maKu) {\n  dataKvalita = 'C_POUZE_KU';\n  zdrojDat.push('RÃšIAN (KÃš)');\n}\n\nif (maBpej) zdrojDat.push('LPIS');\nif (bpejNeniRelevantni) zdrojDat.push('BPEJ N/A');\nif (pvgis.vyroba > 0) zdrojDat.push('PVGIS');\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// CENA ZA MÂ² - S FALLBACK NA VÃMÄšRU Z INZERÃTU\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// Preferovat RÃšIAN vÃ½mÄ›ru, fallback na inzerÃ¡t\nconst vymeraPouzi = celkovaVymera > 0 ? celkovaVymera : vymeraInzerat;\nconst cenaM2 = vymeraPouzi > 0 ? Math.round(cena / vymeraPouzi) : 0;\n\nif (celkovaVymera === 0 && vymeraInzerat > 0) {\n  console.log('  âš ï¸ Cena/mÂ² z vÃ½mÄ›ry inzerÃ¡tu:', cenaM2, 'KÄ/mÂ²');\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// LOG\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\nconsole.log('DATA AGGREGATOR v10 VÃSLEDEK:');\nconsole.log('  Hash:', hashId);\nconsole.log('  Cena:', cena, 'KÄ');\nconsole.log('  Cena/mÂ²:', cenaM2, 'KÄ/mÂ²');\nconsole.log('  KÃš:', kuNazev, '(' + kuKod + ')');\nconsole.log('  Parcely RÃšIAN:', vsechnyParcely.length, 'ks');\nconsole.log('  Parcely z textu:', parcelyZTextu.length, 'ks');\nconsole.log('  VÃ½mÄ›ra RÃšIAN:', celkovaVymera, 'mÂ²');\nconsole.log('  VÃ½mÄ›ra inzerÃ¡t:', vymeraInzerat, 'mÂ²');\nconsole.log('  HlavnÃ­ druh:', hlavniDruhKod, '(' + DRUHY_POZEMKU[hlavniDruhKod] + ')');\nconsole.log('  LV:', lvZTextu || '-');\nconsole.log('  BPEJ:', bpej.kod, bpejNeniRelevantni ? '(nenÃ­ relevantnÃ­)' : ('- tÅ™Ã­da ' + bpej.trida));\nconsole.log('  PVGIS:', pvgis.vyroba, 'kWh/kWp');\nconsole.log('  Kvalita:', dataKvalita);\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// VÃSTUP\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nreturn {\n  json: {\n    // Identifikace\n    hash_id: hashId,\n    dedup_key: priprava.dedup_key || ('sr_' + hashId),\n    \n    // ZÃ¡kladnÃ­ info\n    nazev: nazev,\n    url: url,\n    lokalita: lokalita,\n    \n    // Cena a vÃ½mÄ›ra\n    cena_czk: cena,\n    cena_m2: cenaM2,\n    vymera_inzerat: vymeraInzerat,\n    vymera_m2: celkovaVymera > 0 ? celkovaVymera : vymeraInzerat, // Fallback\n    \n    // GPS\n    gps_original: priprava.gps_original || '',\n    gps_arcgis: priprava.gps_arcgis || '',\n    gps_lat: priprava.gps_lat || '',\n    gps_lon: priprava.gps_lon || '',\n    gps_parcela: gpsParcela,\n    \n    // KÃš\n    ku_nazev: kuNazev,\n    ku_kod: kuKod,\n    \n    // Parcely\n    parcely: parcelyText,\n    parcely_pocet: vsechnyParcely.length > 0 ? vsechnyParcely.length : parcelyZTextu.length,\n    parcely_detail: vsechnyParcely,\n    parcely_z_textu: parcelyZTextu,\n    lv: lvZTextu || '-',\n    \n    // Druh a vyuÅ¾itÃ­\n    druh_pozemku: druhPozemkuText,\n    zpusob_vyuziti: zpusobySet.join(', ') || '-',\n    hlavni_druh_kod: hlavniDruhKod,\n    \n    // BPEJ\n    bpej_kod: bpej.kod,\n    bpej_trida: bpej.trida,\n    bpej_sklon: bpej.sklon,\n    bpej_expozice: bpej.expozice,\n    bpej_popis: bpej.popis,\n    bpej_neni_relevantni: bpejNeniRelevantni,\n    \n    // PVGIS\n    fve_vyroba_kwh: pvgis.vyroba,\n    fve_ozareni: pvgis.ozareni,\n    fve_sklon: pvgis.sklon,\n    fve_azimut: pvgis.azimut,\n    \n    // Metadata\n    ma_presne_udaje: maPresneUdaje,\n    data_kvalita: dataKvalita,\n    zdroje_dat: zdrojDat.join(', '),\n    \n    // Popis\n    popis_text: popis\n  }\n};"
      },
      "id": "81ff9df3-501c-4a90-a961-44542072276a",
      "name": "ğŸ“Š Data Aggregator",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1072,
        992
      ]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“ PARCELA GPS EXTRACTOR v1\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ÃšÄel: Extrahuje pÅ™esnou GPS souÅ™adnici z RÃšIAN parcely pro BPEJ dotaz\n// Vstup: Response z RÃšIAN Parcely HTTP (features[].geometry.rings)\n// VÃ½stup: PÅ¯vodnÃ­ data + gps_parcela (LON,LAT formÃ¡t pro ArcGIS)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// UmÃ­stÄ›nÃ­ ve FLOW:\n//   RÃšIAN Parcely HTTP â†’ ğŸ“ Parcela GPS Extractor â†’ BPEJ HTTP\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst input = $input.item.json;\n\n// ZÃ­skat GPS z PÅ™Ã­prava pro API jako fallback\nlet gpsFallback = '';\ntry {\n  gpsFallback = $('PÅ™Ã­prava pro API').item.json.gps_arcgis || '';\n} catch (e) {\n  try {\n    gpsFallback = $('ğŸ“ GPS Transformer').item.json.gps_arcgis || '';\n  } catch (e2) {\n    try {\n      gpsFallback = $('ğŸ“¦ BATCH Kolekce v7').item.json.gps_arcgis || '';\n    } catch (e3) {\n      console.log('âš ï¸ Fallback GPS nenalezen');\n    }\n  }\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// EXTRAKCE GPS Z PARCELY\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nlet gpsParcela = '';\nlet gpsZdroj = 'FALLBACK';\n\n// Zkontrolovat jestli mÃ¡me features z RÃšIAN\nif (input.features && \n    input.features.length > 0 && \n    input.features[0].geometry && \n    input.features[0].geometry.rings && \n    input.features[0].geometry.rings[0] &&\n    input.features[0].geometry.rings[0][0]) {\n  \n  // PrvnÃ­ bod prvnÃ­ho polygonu prvnÃ­ parcely\n  const prvniBod = input.features[0].geometry.rings[0][0];\n  const lon = prvniBod[0];  // LON je prvnÃ­ (ArcGIS formÃ¡t)\n  const lat = prvniBod[1];  // LAT je druhÃ½\n  \n  // Validace pro ÄŒR (LON: 11-20, LAT: 48-52)\n  if (lon >= 11 && lon <= 20 && lat >= 48 && lat <= 52) {\n    gpsParcela = lon + ',' + lat;\n    gpsZdroj = 'PARCELA';\n    console.log('âœ“ GPS z parcely:', gpsParcela);\n  } else {\n    console.log('âš ï¸ GPS z parcely mimo ÄŒR:', lon, lat);\n    gpsParcela = gpsFallback;\n    gpsZdroj = 'FALLBACK (parcela mimo ÄŒR)';\n  }\n} else {\n  // Parcela nenalezena - pouÅ¾Ã­t fallback\n  gpsParcela = gpsFallback;\n  gpsZdroj = 'FALLBACK (parcela nenalezena)';\n  console.log('âš ï¸ Parcela bez geometrie, pouÅ¾it fallback:', gpsFallback);\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// VÃSTUP - pÅ¯vodnÃ­ data + gps_parcela\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\nconsole.log('ğŸ“ PARCELA GPS EXTRACTOR');\nconsole.log('  Features:', input.features?.length || 0);\nconsole.log('  GPS parcela:', gpsParcela);\nconsole.log('  Zdroj:', gpsZdroj);\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n\nreturn {\n  json: {\n    // PÅ¯vodnÃ­ RÃšIAN response (pro Data Aggregator)\n    ...input,\n    \n    // NovÃ© pole s GPS parcely\n    gps_parcela: gpsParcela,\n    gps_parcela_zdroj: gpsZdroj,\n    \n    // Pro snadnÃ½ pÅ™Ã­stup v BPEJ\n    geometry_for_bpej: gpsParcela\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        400,
        992
      ],
      "id": "9ef444de-5dce-4b5b-a6d5-d880ae868e1c",
      "name": "ğŸ“ Parcela GPS Extractor"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// PÅ™Ã­prava pro API\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ÃšÄel: Transformace GPS pro ArcGIS + pÅ™Ã­prava dat pro RÃšIAN\n// Vstup: Data z Sreality Detail Parser (uÅ¾ mÃ¡ GPS, parcely, LV)\n// VÃ½stup: Data pÅ™ipravenÃ¡ pro RÃšIAN KÃš HTTP, RÃšIAN Parcely HTTP, BPEJ, PVGIS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// [2026-01-29]\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst items = $input.all();\nconst pozemky = [];\n\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\nconsole.log('BATCH KOLEKCE v7 - TRANSFORMACE PRO API');\nconsole.log('  Vstup:', items.length, 'poloÅ¾ek');\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n\nfor (const item of items) {\n  const d = item.json;\n  \n  // Skip prÃ¡zdnÃ½ch\n  if (!d || d._empty) {\n    console.log('  âš ï¸ PÅ™eskakuji prÃ¡zdnou poloÅ¾ku');\n    continue;\n  }\n  \n  const hashId = String(d.hash_id || '').trim();\n  if (!hashId) {\n    console.log('  âš ï¸ PÅ™eskakuji poloÅ¾ku bez hash_id');\n    continue;\n  }\n  \n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // GPS TRANSFORMACE: LAT,LON â†’ LON,LAT (pro ArcGIS)\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // Sreality vracÃ­: \"50.545238,14.020591\" (LAT,LON)\n  // ArcGIS potÅ™ebuje: \"14.020591,50.545238\" (LON,LAT)\n  \n  let gpsArcgis = '';\n  let gpsLat = d.gps_lat || '';\n  let gpsLon = d.gps_lon || '';\n  let gpsValid = d.gps_valid || false;\n  \n  // Pokud mÃ¡me lat/lon z parseru, pouÅ¾ijeme je\n  if (gpsLat && gpsLon) {\n    gpsArcgis = gpsLon + ',' + gpsLat;  // LON,LAT pro ArcGIS!\n  }\n  // Fallback - parsujeme z gps stringu\n  else if (d.gps && d.gps.includes(',')) {\n    const parts = d.gps.split(',');\n    if (parts.length === 2) {\n      gpsLat = parts[0].trim();\n      gpsLon = parts[1].trim();\n      const latNum = parseFloat(gpsLat);\n      const lonNum = parseFloat(gpsLon);\n      \n      // Validace pro ÄŒR\n      if (latNum >= 48 && latNum <= 52 && lonNum >= 11 && lonNum <= 20) {\n        gpsArcgis = gpsLon + ',' + gpsLat;  // LON,LAT pro ArcGIS!\n        gpsValid = true;\n      } else {\n        console.log('  âš ï¸ GPS mimo ÄŒR:', d.gps);\n        gpsValid = false;\n      }\n    }\n  }\n  \n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // PARCELY - pouÅ¾ijeme z Detail Parseru, jen vytvoÅ™Ã­me SQL formÃ¡t\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  \n  const parcelyZTextu = d.parcely_z_textu || [];\n  const parcelySql = parcelyZTextu.length > 0 \n    ? parcelyZTextu.map(p => \"'\" + p + \"'\").join(',')\n    : '';\n  \n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // VÃSTUP\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  \n  const output = {\n    // â”€â”€â”€ Identifikace â”€â”€â”€\n    hash_id: hashId,\n    dedup_key: d.dedup_key || ('sr_' + hashId),\n    \n    // â”€â”€â”€ ZÃ¡kladnÃ­ info z inzerÃ¡tu â”€â”€â”€\n    nazev: d.nazev || '',\n    url: d.url || ('https://www.sreality.cz/detail/prodej/pozemek/bydleni/x/' + hashId),\n    lokalita: d.lokalita || '',\n    kategorie: d.kategorie || 'OstatnÃ­',\n    \n    // â”€â”€â”€ Cena a vÃ½mÄ›ra â”€â”€â”€\n    cena: d.cena || 0,\n    vymera_inzerat: d.vymera_inzerat || 0,\n    \n    // â”€â”€â”€ GPS - RÅ®ZNÃ‰ FORMÃTY â”€â”€â”€\n    gps_original: d.gps || '',           // PÅ¯vodnÃ­ formÃ¡t LAT,LON\n    gps_arcgis: gpsArcgis,               // Pro ArcGIS: LON,LAT\n    gps_lat: gpsLat,                     // Latitude samostatnÄ›\n    gps_lon: gpsLon,                     // Longitude samostatnÄ›\n    gps_valid: gpsValid,\n    \n    // â”€â”€â”€ Popis â”€â”€â”€\n    popis: d.popis || '',\n    \n    // â”€â”€â”€ ExtrahovanÃ© z textu (z Detail Parseru) â”€â”€â”€\n    parcely_z_textu: parcelyZTextu,\n    parcely_sql: parcelySql,             // Pro RÃšIAN WHERE IN klauzuli\n    lv_z_textu: d.lv_z_textu || null,\n    ku_z_textu: d.ku_z_textu || null,\n    \n    // â”€â”€â”€ Flagy pro rozhodovÃ¡nÃ­ â”€â”€â”€\n    ma_parcely: parcelyZTextu.length > 0,\n    ma_lv: d.lv_z_textu !== null && d.lv_z_textu !== undefined,\n    ma_presne_udaje: d.ma_presne_udaje || (parcelyZTextu.length > 0) || (d.lv_z_textu !== null),\n    \n    // â”€â”€â”€ Config (pro dalÅ¡Ã­ nody) â”€â”€â”€\n    config: d.config || {}\n  };\n  \n  pozemky.push({ json: output });\n  \n  console.log('  âœ“', hashId, '|', output.nazev.substring(0, 30), '| GPS:', gpsArcgis || 'CHYBÃ', '| Parcely:', parcelyZTextu.length);\n}\n\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\nconsole.log('BATCH KOLEKCE v7 - VÃSLEDEK:');\nconsole.log('  VÃ½stup:', pozemky.length, 'poloÅ¾ek');\nif (pozemky.length > 0) {\n  const p = pozemky[0].json;\n  console.log('  PÅ™Ã­klad:');\n  console.log('    GPS original:', p.gps_original);\n  console.log('    GPS ArcGIS:', p.gps_arcgis);\n  console.log('    Parcely:', p.parcely_z_textu.join(', ') || 'Å½ÃDNÃ‰');\n  console.log('    Parcely SQL:', p.parcely_sql || 'Å½ÃDNÃ‰');\n  console.log('    LV:', p.lv_z_textu || 'Å½ÃDNÃ‰');\n  console.log('    MÃ¡ pÅ™esnÃ© Ãºdaje:', p.ma_presne_udaje);\n}\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n\nreturn pozemky.length > 0 ? pozemky : [{ json: { _empty: true } }];\n"
      },
      "id": "199ec86a-2001-436f-9001-638e819f75dd",
      "name": "PÅ™Ã­prava pro API",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -272,
        992
      ]
    },
    {
      "parameters": {
        "amount": 0.3
      },
      "id": "ded90f6a-6ace-4e33-89e8-45d757c49809",
      "name": "â³ API Pauza",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -848,
        992
      ],
      "webhookId": "1a7a171c-05f2-4059-8e49-9e1e149cd4c8"
    },
    {
      "parameters": {
        "options": {
          "reset": false
        }
      },
      "id": "143fce1f-2a1f-4d54-9300-a668ad914fd7",
      "name": "ğŸ”„ Sreality Detail Loop",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -1296,
        896
      ]
    },
    {
      "parameters": {
        "url": "=https://www.sreality.cz/api/cs/v2/estates/{{ $json.hash_id }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          },
          "timeout": 60000
        }
      },
      "id": "c4e8bb47-18d3-4b4a-97e8-23fd978956f0",
      "name": "ğŸ  Sreality Detail HTTP",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1072,
        992
      ],
      "alwaysOutputData": true,
      "continueOnFail": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// SREALITY DETAIL PARSER v86 - OPRAVENÃ REGEX PRO PARCELY\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// Opravy v86:\n// - PÅ™idÃ¡n REGEX pro bullet format: \"â€¢ Parcela Ä. 6005\"\n// - PÅ™idÃ¡n REGEX pro LV z bullet formÃ¡tu: \"LV Ä. 642\"\n// - LepÅ¡Ã­ extrakce vÃ½mÄ›ry z popisu\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst httpResponse = $input.item.json;\n\n// ZÃ­skat hash_id z loop nodu\nlet loopItem = {};\ntry {\n  loopItem = $('ğŸ”„ Sreality Detail Loop1').item.json || {};\n} catch (e) {\n  try {\n    loopItem = $('ğŸ”„ Sreality Detail Loop').item.json || {};\n  } catch (e2) {\n    loopItem = {};\n  }\n}\n\nconst hashId = loopItem.hash_id || httpResponse.hash_id || httpResponse._embedded?.estates?.[0]?.hash_id || '';\n\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\nconsole.log('SREALITY DETAIL PARSER v86');\nconsole.log('  Hash ID:', hashId);\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 1. ZÃKLADNÃ DATA Z API RESPONSE\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nlet nazev = '';\nlet popis = '';\nlet cena = 0;\nlet vymeraZInzeratu = 0;\nlet gps = '';\nlet gpsLat = '';\nlet gpsLon = '';\nlet gpsValid = false;\nlet lokalita = '';\nlet url = '';\n\nconst item = httpResponse._embedded?.estates?.[0] || httpResponse;\n\n// NÃZEV\nif (item.name) {\n  nazev = typeof item.name === 'object' ? (item.name.value || '') : item.name;\n}\nif (!nazev && item.meta_description) {\n  nazev = item.meta_description;\n}\nif (!nazev) {\n  nazev = loopItem.nazev || 'Pozemek';\n}\n\n// POPIS\nif (item.text) {\n  popis = typeof item.text === 'object' ? (item.text.value || '') : item.text;\n}\n\n// CENA\nif (item.price_czk?.value_raw) {\n  cena = item.price_czk.value_raw;\n} else if (item.price_czk?.value) {\n  cena = item.price_czk.value;\n} else if (typeof item.price === 'number') {\n  cena = item.price;\n} else {\n  cena = loopItem.cena || 0;\n}\n\n// LOKALITA\nif (item.locality?.value) {\n  lokalita = item.locality.value;\n} else if (item.seo?.locality) {\n  lokalita = item.seo.locality;\n} else {\n  lokalita = loopItem.lokalita || '';\n}\n\n// GPS\nif (item.map?.lat && item.map?.lon) {\n  gpsLat = String(item.map.lat);\n  gpsLon = String(item.map.lon);\n  gps = gpsLat + ',' + gpsLon;\n  gpsValid = true;\n} else if (loopItem.gps) {\n  gps = loopItem.gps;\n  const parts = gps.split(',');\n  if (parts.length === 2) {\n    gpsLat = parts[0].trim();\n    gpsLon = parts[1].trim();\n    gpsValid = true;\n  }\n}\n\n// Validace GPS pro ÄŒR\nif (gpsValid) {\n  const lat = parseFloat(gpsLat);\n  const lon = parseFloat(gpsLon);\n  if (lat < 48 || lat > 52 || lon < 11 || lon > 20) {\n    console.log('  âš ï¸ GPS mimo ÄŒR:', lat, lon);\n    gpsValid = false;\n  }\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// VÃMÄšRA Z INZERÃTU - vÃ­ce metod\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// Metoda 1: Z items pole\nconst itemsData = item.items || [];\nfor (const it of itemsData) {\n  const itName = (it.name || '').toLowerCase();\n  if (itName.includes('plocha') || itName.includes('vÃ½mÄ›ra')) {\n    const val = String(it.value || '').replace(/[^0-9]/g, '');\n    vymeraZInzeratu = parseInt(val) || 0;\n    if (vymeraZInzeratu > 0) break;\n  }\n}\n\n// Metoda 2: Z nÃ¡zvu\nif (!vymeraZInzeratu) {\n  const vymeraMatch = nazev.match(/([\\d\\s]+)\\s*mÂ²/);\n  if (vymeraMatch) {\n    vymeraZInzeratu = parseInt(vymeraMatch[1].replace(/\\s/g, '')) || 0;\n  }\n}\n\n// Metoda 3: Z popisu - \"o vÃ½mÄ›Å™e 2398 mÂ²\"\nif (!vymeraZInzeratu) {\n  const vymeraPopMatch = popis.match(/o\\s+vÃ½mÄ›Å™e\\s+([\\d\\s]+)\\s*mÂ²/i);\n  if (vymeraPopMatch) {\n    vymeraZInzeratu = parseInt(vymeraPopMatch[1].replace(/\\s/g, '')) || 0;\n  }\n}\n\n// Metoda 4: Z popisu - \"celkovÃ© vÃ½mÄ›Å™e 2398 mÂ²\"\nif (!vymeraZInzeratu) {\n  const vymeraCelkMatch = popis.match(/celkov[Ã©e]\\s+vÃ½mÄ›Å™e?\\s+([\\d\\s]+)\\s*mÂ²/i);\n  if (vymeraCelkMatch) {\n    vymeraZInzeratu = parseInt(vymeraCelkMatch[1].replace(/\\s/g, '')) || 0;\n  }\n}\n\n// URL\nconst seoLocality = (item.seo?.locality || lokalita || 'pozemek')\n  .toLowerCase()\n  .replace(/\\s+/g, '-')\n  .replace(/[^a-z0-9-]/g, '');\nurl = 'https://www.sreality.cz/detail/prodej/pozemek/bydleni/x/' + hashId;\n\nconst kategorie = loopItem.kategorie || 'pozemek';\nconst kategorieKod = loopItem.kategorie_kod || 0;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 2. EXTRAKCE PARCEL A LV Z TEXTU - VYLEPÅ ENÃ‰ REGEX\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst fullText = nazev + ' ' + popis;\nconst parcelyZTextu = [];\nconst parcelySet = new Set();\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// REGEX 0: BULLET FORMAT \"â€¢ Parcela Ä. 6005 - o vÃ½mÄ›Å™e\"\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst bulletParcelaRegex = /[â€¢Â·\\-]\\s*Parcela\\s+Ä\\.?\\s*(\\d+(?:\\/\\d+)?)/gi;\nlet matchBullet;\nwhile ((matchBullet = bulletParcelaRegex.exec(fullText)) !== null) {\n  const p = matchBullet[1].trim();\n  if (p && !parcelySet.has(p)) {\n    parcelySet.add(p);\n    parcelyZTextu.push(p);\n    console.log('  âœ“ Parcela z bullet:', p);\n  }\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// REGEX 1: \"parcely Ä. 749, 750, 754, 758/1 a 837/5\"\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst parcelyListMatch = fullText.match(/parcel[ay]?\\s+Ä\\.?\\s*([\\d\\s,/a]+?)(?:\\.|,\\s*(?![\\d])|\\n|v\\s+k\\.?Ãº|$)/i);\nif (parcelyListMatch) {\n  const parcelyStr = parcelyListMatch[1];\n  const parts = parcelyStr.split(/[,\\s]+(?:a\\s+)?|\\s+a\\s+/);\n  for (const p of parts) {\n    const clean = p.trim();\n    if (clean && /^\\d+(?:\\/\\d+)?$/.test(clean) && !parcelySet.has(clean)) {\n      parcelySet.add(clean);\n      parcelyZTextu.push(clean);\n    }\n  }\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// REGEX 2: \"p.Ä. 123\" nebo \"parc. 123/4\" nebo \"parcela 123\"\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst parcelyRegex = /(?:parcela|parc\\.?|p\\.?\\s*Ä\\.?|st\\.)\\s*[:\\s]*(\\d+(?:\\/\\d+)?)/gi;\nlet matchP;\nwhile ((matchP = parcelyRegex.exec(fullText)) !== null) {\n  const p = matchP[1].trim();\n  if (p && !parcelySet.has(p)) {\n    parcelySet.add(p);\n    parcelyZTextu.push(p);\n  }\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// REGEX 3: ÄŒÃ­sla s lomÃ­tkem (123/4, 1234/56) - ale ne datumy\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst cislaLomitkoRegex = /\\b(\\d{2,5}\\/\\d{1,4})\\b/g;\nwhile ((matchP = cislaLomitkoRegex.exec(fullText)) !== null) {\n  const p = matchP[1];\n  // VylouÄit datumy (1/2, 12/24 atd.)\n  const parts = p.split('/');\n  if (parseInt(parts[0]) > 31 || parseInt(parts[1]) > 12) {\n    if (!parcelySet.has(p)) {\n      parcelySet.add(p);\n      parcelyZTextu.push(p);\n    }\n  }\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// REGEX 4: LV (list vlastnictvÃ­) - vÃ­ce formÃ¡tÅ¯\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nlet lvZTextu = null;\n\n// \"LV Ä. 642\"\nconst lvMatch1 = fullText.match(/LV\\s+Ä\\.?\\s*(\\d+)/i);\nif (lvMatch1) {\n  lvZTextu = lvMatch1[1];\n}\n\n// \"list vlastnictvÃ­ Ä. 642\" nebo \"listu vlastnictvÃ­ 642\"\nif (!lvZTextu) {\n  const lvMatch2 = fullText.match(/list[uÅ¯a]?\\s+vlastnictvÃ­\\s+Ä?\\.?\\s*(\\d+)/i);\n  if (lvMatch2) {\n    lvZTextu = lvMatch2[1];\n  }\n}\n\n// \"l.v. 642\"\nif (!lvZTextu) {\n  const lvMatch3 = fullText.match(/l\\.?\\s*v\\.?\\s*Ä?\\.?\\s*(\\d+)/i);\n  if (lvMatch3) {\n    lvZTextu = lvMatch3[1];\n  }\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// REGEX 5: KatastrÃ¡lnÃ­ ÃºzemÃ­ z textu\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nlet kuZTextu = null;\n\n// \"k.Ãº. ÄŒeskÃ© MeziÅ™Ã­ÄÃ­\"\nconst kuMatch1 = fullText.match(/k\\.?\\s*Ãº\\.?\\s+([A-Za-zÃ-Å½Ã¡-Å¾\\s\\-]+?)(?:\\n|LV|$)/i);\nif (kuMatch1) {\n  kuZTextu = kuMatch1[1].trim();\n}\n\n// \"katastrÃ¡lnÃ­ ÃºzemÃ­ Besedice\"\nif (!kuZTextu) {\n  const kuMatch2 = fullText.match(/katastrÃ¡lnÃ­[m]?\\s+Ãºzem[iÃ­]\\s+([A-Za-zÃ-Å½Ã¡-Å¾\\s\\-]+?)(?:\\.|,|\\n|$)/i);\n  if (kuMatch2) {\n    kuZTextu = kuMatch2[1].trim();\n  }\n}\n\nconsole.log('  NÃ¡zev:', nazev.substring(0, 50) + '...');\nconsole.log('  Cena:', cena);\nconsole.log('  VÃ½mÄ›ra z inzerÃ¡tu:', vymeraZInzeratu, 'mÂ²');\nconsole.log('  GPS:', gps, gpsValid ? 'âœ“' : 'âœ—');\nconsole.log('  Parcely:', parcelyZTextu.length, '[' + parcelyZTextu.join(', ') + ']');\nconsole.log('  LV:', lvZTextu || '-');\nconsole.log('  KÃš z textu:', kuZTextu || '-');\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// REGEX 6: \"parcelnÃ­ ÄÃ­slo 182\" nebo \"parcelnÃ­m ÄÃ­slem 182\"\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst parcelniCisloRegex = /parcel[nÃ­Ã©m]+\\s+ÄÃ­sl[oaem]+\\s*(\\d+(?:\\/\\d+)?)/gi;\nlet matchPC;\nwhile ((matchPC = parcelniCisloRegex.exec(fullText)) !== null) {\n  const p = matchPC[1].trim();\n  if (p && !parcelySet.has(p)) {\n    parcelySet.add(p);\n    parcelyZTextu.push(p);\n    console.log('  âœ“ Parcela z \"parcelnÃ­ ÄÃ­slo\":', p);\n  }\n}\n// VÃSTUP\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nreturn {\n  json: {\n    // Identifikace\n    hash_id: hashId,\n    dedup_key: 'sr_' + hashId,\n    \n    // ZÃ¡kladnÃ­ info\n    nazev: nazev,\n    url: url,\n    lokalita: lokalita,\n    kategorie: kategorie,\n    kategorie_kod: kategorieKod,\n    \n    // Cena a vÃ½mÄ›ra\n    cena: cena,\n    vymera_inzerat: vymeraZInzeratu,\n    \n    // GPS\n    gps: gps,\n    gps_lat: gpsLat,\n    gps_lon: gpsLon,\n    gps_valid: gpsValid,\n    \n    // Popis\n    popis: popis,\n    \n    // ExtrahovanÃ© z textu\n    parcely_z_textu: parcelyZTextu,\n    lv_z_textu: lvZTextu,\n    ku_z_textu: kuZTextu,\n    \n    // Flagy\n    ma_parcely: parcelyZTextu.length > 0,\n    ma_lv: lvZTextu !== null,\n    ma_presne_udaje: parcelyZTextu.length > 0 || lvZTextu !== null,\n    \n    // Config\n    config: loopItem.config || {}\n  }\n};\n"
      },
      "id": "7d1cf146-0c35-44d5-9434-ef80f2de8036",
      "name": "ğŸ  Sreality fÃ¡ze 2",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -560,
        992
      ],
      "continueOnFail": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "toolDescription": "VolÃ¡ externÃ­ API pro zÃ­skÃ¡nÃ­ dat o pozemcÃ­ch. POUÅ½IJ POUZE kdyÅ¾ data_kvalita = C_POUZE_KU nebo D_GPS_ONLY!\n\nPokud data_kvalita = A_PARCELY_PRESNE nebo B_GPS_PARCELA â†’ NEVOLEJ TOTO API, mÃ¡Å¡ kompletnÃ­ data!\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nDOSTUPNÃ API A JEJICH URL:\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n1. RÃšIAN KÃš (zjistit katastrÃ¡lnÃ­ ÃºzemÃ­ podle GPS):\nhttps://ags.cuzk.cz/arcgis/rest/services/RUIAN/Prohlizeci_sluzba_nad_daty_RUIAN/MapServer/7/query?geometry={LON},{LAT}&geometryType=esriGeometryPoint&inSR=4326&spatialRel=esriSpatialRelIntersects&outFields=nazev,kod&f=json\n\n2. RÃšIAN PARCELY (zjistit parcely podle GPS):\nhttps://ags.cuzk.cz/arcgis/rest/services/RUIAN/Prohlizeci_sluzba_nad_daty_RUIAN/MapServer/0/query?geometry={LON},{LAT}&geometryType=esriGeometryPoint&inSR=4326&spatialRel=esriSpatialRelIntersects&outFields=vymeraparcely,druhpozemkukod,cisloparcely,zpusobyvyuzitipozemku&returnGeometry=true&f=json\n\n3. RÃšIAN PARCELY podle ÄÃ­sla (pokud znÃ¡Å¡ KÃš kÃ³d):\nhttps://ags.cuzk.cz/arcgis/rest/services/RUIAN/Prohlizeci_sluzba_nad_daty_RUIAN/MapServer/0/query?where=katastralniuzemi={KU_KOD}+AND+cisloparcely='{CISLO_PARCELY}'&outFields=vymeraparcely,druhpozemkukod,cisloparcely,zpusobyvyuzitipozemku&returnGeometry=true&f=json\n\n4. BPEJ (bonita pÅ¯dy) - POZOR: MUSÃ obsahovat where=1%3D1:\nhttps://services-eu1.arcgis.com/BHXB6o04ZWuSXg2G/arcgis/rest/services/BPEJ_obohacene/FeatureServer/0/query?where=1%3D1&geometry={LON},{LAT}&geometryType=esriGeometryPoint&inSR=4326&spatialRel=esriSpatialRelIntersects&outFields=BPEJ,TO_ZPF,PT_NAZEV&returnGeometry=false&f=json\n\n5. PVGIS (solÃ¡rnÃ­ potenciÃ¡l) - POZOR: opaÄnÃ© poÅ™adÃ­ lat/lon:\nhttps://re.jrc.ec.europa.eu/api/v5_3/PVcalc?lat={LAT}&lon={LON}&peakpower=1&loss=14&outputformat=json&optimalangles=1\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nGPS SOUÅ˜ADNICE - KRITICKÃ‰!\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nPro ArcGIS (RÃšIAN, BPEJ): geometry={LON},{LAT}\n  â†’ LON je PRVNÃ (ÄÃ­slo 12-19 pro ÄŒR)\n  â†’ LAT je DRUHÃ‰ (ÄÃ­slo 48-51 pro ÄŒR)\n  â†’ PouÅ¾ij hodnotu z gps_arcgis nebo gps_parcela (uÅ¾ je ve sprÃ¡vnÃ©m poÅ™adÃ­!)\n\nPro PVGIS: lat={LAT}&lon={LON}\n  â†’ NormÃ¡lnÃ­ poÅ™adÃ­\n  â†’ PouÅ¾ij hodnoty gps_lat a gps_lon\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nDEKÃ“DOVÃNÃ ODPOVÄšDÃ:\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\ndruhpozemkukod:\n  2 = ornÃ¡ pÅ¯da\n  3 = chmelnice\n  4 = vinice\n  5 = zahrada\n  6 = ovocnÃ½ sad\n  7 = trvalÃ½ travnÃ­ porost (TTP/louka)\n  10 = lesnÃ­ pozemek\n  11 = vodnÃ­ plocha\n  13 = zastavÄ›nÃ¡ plocha\n  14 = ostatnÃ­ plocha\n\nTO_ZPF (tÅ™Ã­da ochrany ZPF):\n  I, II = Vysoce chrÃ¡nÄ›nÃ¡ pÅ¯da â†’ obtÃ­Å¾nÃ© vynÄ›tÃ­ â†’ MALUS pro FVE\n  III, IV, V = MÃ©nÄ› chrÃ¡nÄ›nÃ¡ â†’ snadnÃ© vynÄ›tÃ­ â†’ BONUS pro FVE\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nDÅ®LEÅ½ITÃ‰:\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nâ€¢ NIKDY nedekÃ³duj 1%3D1 na 1=1 v BPEJ URL!\nâ€¢ Pokud API vrÃ¡tÃ­ prÃ¡zdnÃ© features[], pozemek nenÃ­ v databÃ¡zi\nâ€¢ Pro BPEJ: prÃ¡zdnÃ½ vÃ½sledek = pozemek nenÃ­ zemÄ›dÄ›lskÃ¡ pÅ¯da",
        "url": "={url}",
        "placeholderDefinitions": {
          "values": [
            {
              "name": "url",
              "description": "KompletnÃ­ URL. Pro ArcGIS je geometry={LON},{LAT} (PROHOZENÃ‰!). Pro PVGIS je lat={LAT}&lon={LON}. Nikdy nedekÃ³duj %3D.",
              "type": "string"
            }
          ]
        },
        "optimizeResponse": true
      },
      "id": "2f03824a-12f5-437f-8975-0cf14c47105e",
      "name": "HTTP_API_Tool",
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1.1,
      "position": [
        -496,
        800
      ]
    },
    {
      "parameters": {},
      "id": "37f73e3e-2436-4c4b-a664-e8e492813f66",
      "name": "ğŸ  Next Detail",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        1296,
        1056
      ]
    },
    {
      "parameters": {
        "url": "https://services-eu1.arcgis.com/BHXB6o04ZWuSXg2G/arcgis/rest/services/BPEJ_obohacene/FeatureServer/0/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "where",
              "value": "1=1"
            },
            {
              "name": "geometry",
              "value": "={{ $('ğŸ“ Parcela GPS Extractor').item.json.gps_parcela }}"
            },
            {
              "name": "geometryType",
              "value": "esriGeometryPoint"
            },
            {
              "name": "inSR",
              "value": "4326"
            },
            {
              "name": "spatialRel",
              "value": "esriSpatialRelIntersects"
            },
            {
              "name": "outFields",
              "value": "BPEJ,TO_ZPF,KOD_KR,KlimRegion,Skeletovit,Sklon,SklStupne,Expozice,Hloubka,KOD_HPJ,PT_NAZEV"
            },
            {
              "name": "returnGeometry",
              "value": "false"
            },
            {
              "name": "f",
              "value": "json"
            }
          ]
        },
        "options": {
          "timeout": 15000
        }
      },
      "id": "90151a79-e88c-41a1-9083-b3628c67b8e5",
      "name": "ğŸŒ¾ BPEJ HTTP",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        624,
        896
      ],
      "alwaysOutputData": true,
      "continueOnFail": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "url": "https://ags.cuzk.cz/arcgis/rest/services/RUIAN/Prohlizeci_sluzba_nad_daty_RUIAN/MapServer/0/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "where",
              "value": "={{ $('PÅ™Ã­prava pro API').item.json.ma_parcely && $('ğŸ—ºï¸ RÃšIAN KÃš HTTP').item.json.features && $('ğŸ—ºï¸ RÃšIAN KÃš HTTP').item.json.features.length > 0 ? 'katastralniuzemi=' + $('ğŸ—ºï¸ RÃšIAN KÃš HTTP').item.json.features[0].attributes.kod + ' AND cisloparcely IN (' + $('PÅ™Ã­prava pro API').item.json.parcely_sql + ')' : '1=1' }}"
            },
            {
              "name": "geometry",
              "value": "={{ $('PÅ™Ã­prava pro API').item.json.ma_parcely ? '' : $('PÅ™Ã­prava pro API').item.json.gps_arcgis }}"
            },
            {
              "name": "geometryType",
              "value": "esriGeometryPoint"
            },
            {
              "name": "inSR",
              "value": "4326"
            },
            {
              "name": "spatialRel",
              "value": "esriSpatialRelIntersects"
            },
            {
              "name": "outFields",
              "value": "cisloparcely,druhpozemkukod,zpusobyvyuzitipozemku,vymeraparcely,katastralniuzemi"
            },
            {
              "name": "returnGeometry",
              "value": "true"
            },
            {
              "name": "outSR",
              "value": "4326"
            },
            {
              "name": "f",
              "value": "json"
            }
          ]
        },
        "options": {
          "timeout": 15000
        }
      },
      "id": "79c18a8b-d377-48fe-a4ea-aa245f63f793",
      "name": "ğŸ—ºï¸ RÃšIAN Parcely HTTP",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        176,
        992
      ],
      "alwaysOutputData": true,
      "continueOnFail": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "Analyzuj tento pozemek a vraÅ¥ JSON hodnocenÃ­:\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ“Š KVALITA DAT: {{ $json.data_kvalita }}\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nğŸ”· ZÃKLADNÃ INFO:\nâ€¢ Hash ID: {{ $json.hash_id }}\nâ€¢ NÃ¡zev: {{ $json.nazev }}\nâ€¢ Lokalita: {{ $json.lokalita }}\nâ€¢ URL: {{ $json.url }}\nâ€¢ Cena: {{ $json.cena_czk }} KÄ\nâ€¢ Cena/mÂ²: {{ $json.cena_m2 }} KÄ\n\nğŸ”· LOKALIZACE:\nâ€¢ KÃš: {{ $json.ku_nazev }} (kÃ³d: {{ $json.ku_kod }})\nâ€¢ GPS pÅ¯vodnÃ­: {{ $json.gps_original }}\nâ€¢ GPS ArcGIS: {{ $json.gps_arcgis }}\nâ€¢ GPS parcely: {{ $json.gps_parcela }}\nâ€¢ LAT: {{ $json.gps_lat }}\nâ€¢ LON: {{ $json.gps_lon }}\n\nğŸ”· PARCELY ({{ $json.parcely_pocet }} ks):\nâ€¢ Seznam: {{ $json.parcely }}\nâ€¢ VÃ½mÄ›ra RÃšIAN: {{ $json.vymera_m2 }} mÂ²\nâ€¢ VÃ½mÄ›ra inzerÃ¡t: {{ $json.vymera_inzerat }} mÂ²\nâ€¢ LV: {{ $json.lv }}\n\nğŸ”· DRUH A VYUÅ½ITÃ:\nâ€¢ Druh: {{ $json.druh_pozemku }}\nâ€¢ VyuÅ¾itÃ­: {{ $json.zpusob_vyuziti }}\n\nğŸ”· BPEJ (bonita pÅ¯dy):\nâ€¢ KÃ³d: {{ $json.bpej_kod }}\nâ€¢ TÅ™Ã­da ZPF: {{ $json.bpej_trida }}\nâ€¢ Sklon: {{ $json.bpej_sklon }}\nâ€¢ Expozice: {{ $json.bpej_expozice }}\nâ€¢ Popis: {{ $json.bpej_popis }}\n\nğŸ”· FVE POTENCIÃL (PVGIS):\nâ€¢ VÃ½roba: {{ $json.fve_vyroba_kwh }} kWh/kWp\nâ€¢ OzÃ¡Å™enÃ­: {{ $json.fve_ozareni }} kWh/mÂ²\nâ€¢ Sklon: {{ $json.fve_sklon }}Â°\nâ€¢ Azimut: {{ $json.fve_azimut }}Â°\n\nğŸ”· POPIS INZERÃTU:\n{{ $json.popis_text }}\n\nğŸ”· METADATA:\nâ€¢ Zdroje: {{ $json.zdroje_dat }}\nâ€¢ Kvalita: {{ $json.data_kvalita }}\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nVRAÅ¤ POUZE TENTO JSON (vyplÅˆ hodnoty oznaÄenÃ© VYPLÅ‡):\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n{\n  \"id_hash\": \"{{ $json.hash_id }}\",\n  \"nazev\": \"{{ $json.nazev }}\",\n  \"lokalita\": \"{{ $json.lokalita }}\",\n  \"url\": \"{{ $json.url }}\",\n  \"cena_czk\": {{ $json.cena_czk || 0 }},\n  \"cena_m2\": {{ $json.cena_m2 || 0 }},\n  \"vymera_inzerat_m2\": {{ $json.vymera_inzerat || 0 }},\n  \"vymera_ruian_m2\": {{ $json.vymera_m2 || 0 }},\n  \"gps_lon_lat\": \"{{ $json.gps_parcela || $json.gps_arcgis }}\",\n  \"katastralni_uzemi\": \"{{ $json.ku_nazev }}\",\n  \"ku_kod\": \"{{ $json.ku_kod }}\",\n  \"parcely\": \"{{ $json.parcely }}\",\n  \"pocet_parcel\": {{ $json.parcely_pocet || 0 }},\n  \"listy_vlastnictvi\": \"{{ $json.lv }}\",\n  \"druh_pozemku\": \"{{ $json.druh_pozemku }}\",\n  \"zpusob_vyuziti\": \"{{ $json.zpusob_vyuziti }}\",\n  \"bpej_kod\": \"{{ $json.bpej_kod }}\",\n  \"bpej_sklonitost\": \"{{ $json.bpej_sklon }}\",\n  \"bpej_orientace\": \"{{ $json.bpej_expozice }}\",\n  \"trida_zpf\": \"{{ $json.bpej_trida }}\",\n  \"popis_pudy\": \"{{ $json.bpej_popis }}\",\n  \"fve_rocni_vyroba_kwh_kwp\": {{ $json.fve_vyroba_kwh || 0 }},\n  \"fve_rocni_ozareni_kwh_m2\": {{ $json.fve_ozareni || 0 }},\n  \"fve_optimalny_sklon\": {{ $json.fve_sklon || 0 }},\n  \"fve_optimalny_azimut\": {{ $json.fve_azimut || 0 }},\n  \"rating_stavebni\": VYPLÅ‡_ÄŒÃSLO_0-100,\n  \"rating_fve\": VYPLÅ‡_ÄŒÃSLO_0-100,\n  \"rating_mve\": VYPLÅ‡_ÄŒÃSLO_0-100,\n  \"doporucene_vyuziti\": \"VYPLÅ‡_JEDNO: STAVBA / FVE / ZEMÄšDÄšLSTVÃ / LES / SPEKULACE / REKREACE\",\n  \"hlavni_vyhoda\": \"VYPLÅ‡_MAX_50_ZNAKÅ®\",\n  \"hlavni_bariera\": \"VYPLÅ‡_MAX_50_ZNAKÅ®\",\n  \"analyza_text\": \"VYPLÅ‡_2-3_VÄšTY_ANALÃZY\",\n  \"zdroje_dat\": \"{{ $json.zdroje_dat }}\",\n  \"data_kvalita\": \"{{ $json.data_kvalita }}\"\n}",
        "options": {
          "systemMessage": "Jsi expert na investiÄnÃ­ analÃ½zu pozemkÅ¯ v ÄŒeskÃ© republice.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nTVOJE ROLE\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n- AnalyzujeÅ¡ pozemky z hlediska investiÄnÃ­ho potenciÃ¡lu\n- HodnotÃ­Å¡ vhodnost pro: stavbu, fotovoltaiku (FVE), malou vodnÃ­ elektrÃ¡rnu (MVE)\n- PracujeÅ¡ s daty z RÃšIAN, BPEJ (LPIS) a PVGIS\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nKVALITA DAT - ROZHODOVACÃ LOGIKA\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nâ€¢ A_PARCELY_PRESNE = Data z parcel uvedenÃ½ch v inzerÃ¡tu â†’ NEJSPOLEHLIVÄšJÅ Ã\nâ€¢ B_GPS_PARCELA = Data z parcely na GPS souÅ™adnici â†’ SPOLEHLIVÃ‰\nâ€¢ C_POUZE_KU = Pouze katastrÃ¡lnÃ­ ÃºzemÃ­ â†’ NEKOMPLETNÃ\nâ€¢ D_GPS_ONLY = Pouze GPS, Å¾Ã¡dnÃ¡ RÃšIAN data â†’ NEKOMPLETNÃ\n\nPRAVIDLO:\nâ†’ Pokud data_kvalita = A nebo B â†’ MÃÅ  KOMPLETNÃ DATA â†’ NEVOLEJ API!\nâ†’ Pokud data_kvalita = C nebo D â†’ MÅ®Å½EÅ  pouÅ¾Ã­t HTTP_API_Tool pro doplnÄ›nÃ­\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nZÃKLADNÃ PRAVIDLA\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n1. PouÅ¾Ã­vej POUZE data kterÃ¡ dostaneÅ¡ - NEVYMÃÅ LEJ si!\n2. VÃ½mÄ›ru NESÄŒÃTEJ - uÅ¾ je seÄtenÃ¡ v poli vymera_m2\n3. Cenu za mÂ² NEPOÄŒÃTEJ - uÅ¾ je spoÄÃ­tanÃ¡ v poli cena_m2\n4. VÅ¾dy vraÅ¥ ÄŒISTÃ JSON bez markdown blokÅ¯ (bez ```json)\n5. Å½Ã¡dnÃ½ text pÅ™ed ani za JSON!\n\nBPEJ - DÅ®LEÅ½ITÃ‰\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n- Pokud bpej_kod = \"NEMÃ (nenÃ­ ZPF)\" â†’ pozemek NENÃ zemÄ›dÄ›lskÃ¡ pÅ¯da (les, vodnÃ­ plocha, zastavÄ›nÃ¡, ostatnÃ­)\n  â†’ NEDOHLEDÃVEJ BPEJ pÅ™es API, nenÃ­ to chyba, tento typ pozemku BPEJ nemÃ¡\n  â†’ Pro FVE rating: NepÅ™Ã­tomnost BPEJ u lesa/vodnÃ­ plochy je VÃHODA (nemusÃ­ se vyjÃ­mat ze ZPF)\n  \n- Pokud bpej_kod = \"NENÃ V LPIS\" â†’ mÄ›la by bÃ½t zemÄ›dÄ›lskÃ¡ pÅ¯da ale nenÃ­ v databÃ¡zi\n  â†’ MoÅ¾nÃ¡ chyba GPS nebo novÃ¡ parcela\n  â†’ MÅ®Å½EÅ  zkusit dohledat pÅ™es API pokud mÃ¡Å¡ GPS\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nHODNOCENÃ STAVEBNÃ (0-100)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nBONUS body:\n+ Druh \"zastavÄ›nÃ¡ plocha\" nebo \"zahrada\" = +30\n+ Druh \"ostatnÃ­ plocha\" = +20\n+ ZmÃ­nka o sÃ­tÃ­ch v popisu = +15\n+ ZmÃ­nka o pÅ™Ã­stupu/komunikaci = +10\n+ ZmÃ­nka o ÃºzemnÃ­m plÃ¡nu = +10\n+ MalÃ¡ vÃ½mÄ›ra (< 2000 mÂ²) = +10\n\nMALUS body:\n- Druh \"ornÃ¡ pÅ¯da\" = -20\n- Druh \"lesnÃ­ pozemek\" = -30\n- Druh \"vodnÃ­ plocha\" = -40\n- BPEJ tÅ™Ã­da I-II (chrÃ¡nÄ›nÃ¡ pÅ¯da) = -15\n- Bez pÅ™Ã­stupu = -20\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nHODNOCENÃ FVE (0-100)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nBONUS body:\n+ BPEJ tÅ™Ã­da III = +10\n+ BPEJ tÅ™Ã­da IV = +20\n+ BPEJ tÅ™Ã­da V = +30\n+ BPEJ \"NENÃ V LPIS\" (moÅ¾nÃ¡ nenÃ­ ZPF) = +25\n+ Expozice J (jih) = +15\n+ Expozice JV nebo JZ = +10\n+ Sklon \"rovina 0-3Â°\" = +15\n+ Sklon \"mÃ­rnÃ½ 3-7Â°\" = +10\n+ PVGIS vÃ½roba > 1100 kWh/kWp = +10\n+ PVGIS vÃ½roba > 1150 kWh/kWp = +15\n+ VÃ½mÄ›ra > 5000 mÂ² = +10\n+ VÃ½mÄ›ra > 10000 mÂ² = +20\n+ VÃ½mÄ›ra > 20000 mÂ² = +25\n\nMALUS body:\n- BPEJ tÅ™Ã­da I = -30 (vysoce chrÃ¡nÄ›nÃ¡ pÅ¯da)\n- BPEJ tÅ™Ã­da II = -20 (chrÃ¡nÄ›nÃ¡ pÅ¯da)\n- Expozice S (sever) = -20\n- Expozice SV nebo SZ = -10\n- Sklon \"prudkÃ½ >17Â°\" = -20\n- Sklon \"vÃ½raznÃ½ 12-17Â°\" = -10\n- Druh \"lesnÃ­ pozemek\" = -30\n- Druh \"vodnÃ­ plocha\" = -40\n- VÃ½mÄ›ra < 1000 mÂ² = -20\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nHODNOCENÃ MVE (0-100)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nBONUS body:\n+ Druh \"vodnÃ­ plocha\" = +40\n+ ZmÃ­nka o vodnÃ­m toku/potoku/Å™ece v popisu = +30\n+ ZmÃ­nka o jezu/nÃ¡honu = +20\n+ VÃ½raznÃ½ sklon terÃ©nu = +10\n\nVÃCHOZÃ: Pokud nenÃ­ vodnÃ­ tok â†’ rating_mve = 5-15\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nDOPORUÄŒENÃ‰ VYUÅ½ITÃ\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nVyber JEDNO hlavnÃ­ doporuÄenÃ­ podle nejvyÅ¡Å¡Ã­ho ratingu:\nâ€¢ \"STAVBA\" - pokud rating_stavebni > 60\nâ€¢ \"FVE\" - pokud rating_fve > 60 a vÃ½mÄ›ra > 3000 mÂ²\nâ€¢ \"ZEMÄšDÄšLSTVÃ\" - pokud BPEJ tÅ™Ã­da I-II a druh ornÃ¡/TTP\nâ€¢ \"LES\" - pokud druh lesnÃ­ pozemek\nâ€¢ \"SPEKULACE\" - pokud Å¾Ã¡dnÃ© z vÃ½Å¡e, ale nÃ­zkÃ¡ cena/mÂ²\nâ€¢ \"REKREACE\" - pokud hezkÃ¡ lokalita, menÅ¡Ã­ vÃ½mÄ›ra\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nFORMÃT VÃSTUPU\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nVraÅ¥ POUZE JEDEN ÄŒISTÃ JSON objekt.\n- Å½Ã¡dnÃ½ markdown (bez ```json)\n- Å½Ã¡dnÃ½ text pÅ™ed JSON\n- Å½Ã¡dnÃ½ text za JSON\n- Pouze validnÃ­ JSON"
        }
      },
      "id": "9a3825e6-0e1a-4c1a-96c1-655c4da62d8c",
      "name": "ğŸï¸ PozemkovÃ½ Analytik v6",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        -624,
        576
      ]
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        848,
        992
      ],
      "id": "e5f39989-1327-4685-9840-3ac79b8a527e",
      "name": "Merge"
    },
    {
      "parameters": {
        "url": "https://re.jrc.ec.europa.eu/api/v5_3/PVcalc",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "lat",
              "value": "={{ $('ğŸ“ Parcela GPS Extractor').item.json.gps_parcela.split(',')[1] }}"
            },
            {
              "name": "lon",
              "value": "={{ $('ğŸ“ Parcela GPS Extractor').item.json.gps_parcela.split(',')[0] }}"
            },
            {
              "name": "peakpower",
              "value": "1"
            },
            {
              "name": "loss",
              "value": "14"
            },
            {
              "name": "outputformat",
              "value": "json"
            },
            {
              "name": "optimalangles",
              "value": "1"
            }
          ]
        },
        "options": {
          "timeout": 30000
        }
      },
      "id": "579accd5-6347-4d3e-8869-7357f35d7ce1",
      "name": "â˜€ï¸ PVGIS HTTP",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        624,
        1088
      ],
      "alwaysOutputData": true,
      "continueOnFail": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "url": "https://ags.cuzk.cz/arcgis/rest/services/RUIAN/Prohlizeci_sluzba_nad_daty_RUIAN/MapServer/7/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "geometry",
              "value": "={{ $json.gps_arcgis }}"
            },
            {
              "name": "geometryType",
              "value": "esriGeometryPoint"
            },
            {
              "name": "inSR",
              "value": "4326"
            },
            {
              "name": "spatialRel",
              "value": "esriSpatialRelIntersects"
            },
            {
              "name": "outFields",
              "value": "nazev,kod"
            },
            {
              "name": "returnGeometry",
              "value": "false"
            },
            {
              "name": "f",
              "value": "json"
            }
          ]
        },
        "options": {
          "timeout": 15000
        }
      },
      "id": "14e180ca-2c41-4e99-85bf-5ef5be0c623f",
      "name": "ğŸ—ºï¸ RÃšIAN KÃš HTTP",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -48,
        992
      ],
      "alwaysOutputData": true,
      "continueOnFail": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// VÃSTUPNÃ PARSER v7 - S PREFIXY PODLE ZDROJE DAT\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// Prefixy:\n//   âœ“ = OvÄ›Å™enÃ¡ data (RÃšIAN, BPEJ, PVGIS)\n//   â—‰ = Data z inzerÃ¡tu\n//   âš™ = VypoÄÃ­tanÃ¡ data\n//   âš¡ = Data od AI\n//   âœ— = ChybÃ­ / neovÄ›Å™eno\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst input = $input.first().json;\n\n// ZÃ­skat pÅ¯vodnÃ­ data z loop nodu (pro fallback)\nlet loopItem = {};\ntry {\n  loopItem = $('ğŸ”„ Pozemek Loop').first().json || {};\n} catch (e) {\n  try {\n    loopItem = $('Pozemek Loop').first().json || {};\n  } catch (e2) {\n    console.log('âš ï¸ Loop item nenalezen');\n  }\n}\n\nlet dataAgg = {};\ntry {\n  dataAgg = $('ğŸ“Š Data Aggregator').first().json || {};\n} catch (e) {}\n\nlet results = [];\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// PARSOVÃNÃ JSON Z AI\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\ntry {\n  let text = input.output || input.text || input.response || input.message?.content || '';\n  \n  if (typeof text === 'object') {\n    text = JSON.stringify(text);\n  }\n  \n  text = text.replace(/```json\\s*/gi, '').replace(/```\\s*/gi, '').trim();\n  \n  const arrayMatch = text.match(/\\[[\\s\\S]*\\]/);\n  if (arrayMatch) {\n    results = JSON.parse(arrayMatch[0]);\n  } else {\n    const objMatch = text.match(/\\{[\\s\\S]*\\}/);\n    if (objMatch) {\n      results = [JSON.parse(objMatch[0])];\n    }\n  }\n  \n  console.log('âœ“ Parsed', results.length, 'results from AI');\n  \n} catch (e) {\n  console.log('âœ— Parse error:', e.message);\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// FALLBACK - pokud AI nevrÃ¡tila validnÃ­ JSON\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nif (!results || results.length === 0) {\n  console.log('âš ï¸ Using fallback data');\n  results = [{\n    id_hash: loopItem.hash_id || '',\n    nazev: loopItem.nazev || '',\n    lokalita: loopItem.lokalita || '',\n    url: loopItem.url || '',\n    cena_czk: loopItem.cena_czk || 0,\n    cena_m2: loopItem.cena_m2 || 0,\n    vymera_inzerat_m2: loopItem.vymera_inzerat || 0,\n    vymera_ruian_m2: loopItem.vymera_m2 || 0,\n    gps_lon_lat: loopItem.gps_parcela || loopItem.gps_arcgis || '',\n    katastralni_uzemi: loopItem.ku_nazev || '',\n    ku_kod: loopItem.ku_kod || '',\n    parcely: loopItem.parcely || '',\n    pocet_parcel: loopItem.parcely_pocet || 0,\n    listy_vlastnictvi: loopItem.lv || '',\n    druh_pozemku: loopItem.druh_pozemku || '',\n    zpusob_vyuziti: loopItem.zpusob_vyuziti || '',\n    bpej_kod: loopItem.bpej_kod || '',\n    trida_zpf: loopItem.bpej_trida || '',\n    bpej_sklonitost: loopItem.bpej_sklon || '',\n    bpej_orientace: loopItem.bpej_expozice || '',\n    popis_pudy: loopItem.bpej_popis || '',\n    fve_rocni_vyroba_kwh_kwp: loopItem.fve_vyroba_kwh || 0,\n    fve_rocni_ozareni_kwh_m2: loopItem.fve_ozareni || 0,\n    fve_optimalny_sklon: loopItem.fve_sklon || 0,\n    fve_optimalny_azimut: loopItem.fve_azimut || 0,\n    rating_stavebni: 0,\n    rating_fve: 0,\n    rating_mve: 0,\n    doporucene_vyuziti: '',\n    hlavni_vyhoda: '',\n    hlavni_bariera: '',\n    analyza_text: '',\n    zdroje_dat: loopItem.zdroje_dat || '',\n    data_kvalita: loopItem.data_kvalita || 'D_GPS_ONLY'\n  }];\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// POMOCNÃ‰ FUNKCE - PREFIXY\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// âœ“ = OvÄ›Å™enÃ¡ data (RÃšIAN, BPEJ, PVGIS)\n// â—‰ = Data z inzerÃ¡tu\n// âš™ = VypoÄÃ­tanÃ¡ data\n// âš¡ = Data od AI\n// âœ— = ChybÃ­\n\nfunction p_overeno(val) {\n  if (val === null || val === undefined || val === '' || val === 0 || val === '-') return 'âœ— -';\n  return 'âœ“ ' + val;\n}\n\nfunction p_inzerat(val) {\n  if (val === null || val === undefined || val === '' || val === 0 || val === '-') return 'âœ— -';\n  return 'â—‰ ' + val;\n}\n\nfunction p_vypocet(val) {\n  if (val === null || val === undefined || val === '' || val === 0 || val === '-') return 'âœ— -';\n  return 'âš™ ' + val;\n}\n\nfunction p_ai(val) {\n  if (val === null || val === undefined || val === '' || val === 0 || val === '-') return 'âœ— -';\n  return 'âš¡ ' + val;\n}\n\nfunction p_auto(val, zdroj) {\n  // zdroj: 'ruian', 'bpej', 'pvgis', 'inzerat', 'vypocet', 'ai'\n  if (val === null || val === undefined || val === '' || val === 0 || val === '-') return 'âœ— -';\n  \n  switch(zdroj) {\n    case 'ruian':\n    case 'bpej':\n    case 'pvgis':\n      return 'âœ“ ' + val;\n    case 'inzerat':\n      return 'â—‰ ' + val;\n    case 'vypocet':\n      return 'âš™ ' + val;\n    case 'ai':\n      return 'âš¡ ' + val;\n    default:\n      return 'â—‰ ' + val;\n  }\n}\n\nfunction getVerdikt(rating) {\n  const r = parseInt(rating) || 0;\n  if (r >= 75) return 'â­â­â­ VYNIKAJÃCÃ';\n  if (r >= 50) return 'â­â­ DOBRÃ';\n  if (r >= 25) return 'â­ PODMÃNÄšNÃ';\n  return 'âŒ NEVHODNÃ';\n}\n\nfunction kontrolaVymery(vymeraInz, vymeraRuian) {\n  if (!vymeraInz || vymeraInz <= 0) return 'âœ— CHYBÃ INZERÃT';\n  if (!vymeraRuian || vymeraRuian <= 0) return 'âœ— CHYBÃ RÃšIAN';\n  \n  const rozdil = Math.abs(vymeraInz - vymeraRuian);\n  const procento = Math.round((rozdil / Math.max(vymeraInz, vymeraRuian)) * 100);\n  \n  if (procento <= 5) return 'âš™ âœ“ OK';\n  if (procento <= 15) return 'âš™ âš ï¸ ' + procento + '%';\n  return 'âš™ âŒ ' + procento + '%';\n}\n\nfunction zkratPopis(text, maxLen = 1000) {\n  if (!text) return '';\n  if (text.length <= maxLen) return text;\n  return text.substring(0, maxLen - 3) + '...';\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// TRANSFORMACE DO VÃSTUPNÃHO FORMÃTU\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\nconsole.log('VÃSTUPNÃ PARSER v7 - S PREFIXY');\nconsole.log('  PoloÅ¾ek:', results.length);\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n\nreturn results.map((d) => {\n  const vymeraInz = parseInt(d.vymera_inzerat_m2) || 0;\n  const vymeraRuian = parseInt(d.vymera_ruian_m2) || 0;\n  const cena = parseInt(d.cena_czk) || 0;\n  const cenaM2 = parseInt(d.cena_m2) || (vymeraRuian > 0 && cena > 0 ? Math.round(cena / vymeraRuian) : 0);\n  \n  const ratingStavebni = parseInt(d.rating_stavebni) || 0;\n  const ratingFve = parseInt(d.rating_fve) || 0;\n  const ratingMve = parseInt(d.rating_mve) || 0;\n  \n  const hashId = d.id_hash || d.hash_id || '';\n  \n  // UrÄenÃ­ zdroje GPS\n  const maGpsParcela = dataAgg.gps_parcela && dataAgg.gps_parcela !== '';\n  const maGpsInzerat = dataAgg.gps_arcgis && dataAgg.gps_arcgis !== '';\n  const gpsHodnota = d.gps_lon_lat || dataAgg.gps_parcela || dataAgg.gps_arcgis || '';\n  const gpsZdroj = maGpsParcela ? 'ruian' : (maGpsInzerat ? 'inzerat' : null);\n  \n  // UrÄenÃ­ zdroje vÃ½mÄ›ry\n  const maVymeruRuian = vymeraRuian > 0;\n  \n  // UrÄenÃ­ zdroje BPEJ\n  const maBpej = d.bpej_kod && d.bpej_kod !== '' && d.bpej_kod !== 'NENÃ V LPIS';\n  \n  // UrÄenÃ­ zdroje FVE\n  const maFve = (d.fve_rocni_vyroba_kwh_kwp || 0) > 0;\n\n  return {\n    json: {\n      // â•â•â• IDENTIFIKACE (bez prefixu - vÅ¾dy z inzerÃ¡tu) â•â•â•\n      'ID [hash]': hashId ? `sr_${hashId}` : '',\n      'NÃ¡zev': d.nazev || '',\n      'Lokalita': d.lokalita || '',\n      'URL': 'https://www.sreality.cz/detail/prodej/pozemek/bydleni/x/' + hashId,\n      \n      // â•â•â• CENA A VÃMÄšRA â•â•â•\n      'Cena [KÄ]': p_inzerat(cena),\n      'Cena/mÂ² [KÄ]': p_vypocet(cenaM2),\n      'VÃ½mÄ›ra inzerÃ¡t [mÂ²]': p_inzerat(vymeraInz),\n      'VÃ½mÄ›ra RÃšIAN [mÂ²]': p_overeno(vymeraRuian),\n      'Kontrola vÃ½mÄ›ry': kontrolaVymery(vymeraInz, vymeraRuian),\n      \n      // â•â•â• LOKALIZACE â•â•â•\n      'GPS [LON,LAT]': p_auto(gpsHodnota, gpsZdroj),\n      'KatastrÃ¡lnÃ­ ÃºzemÃ­': p_overeno(d.katastralni_uzemi || ''),\n      'KÃ³d KÃš': p_overeno(d.ku_kod || ''),\n      \n      // â•â•â• PARCELY â•â•â•\n      'Parcely': maVymeruRuian ? p_overeno(d.parcely || '') : p_inzerat(d.parcely || ''),\n      'PoÄet parcel': maVymeruRuian ? p_overeno(d.pocet_parcel || '') : p_inzerat(d.pocet_parcel || ''),\n      'LV': p_inzerat(d.listy_vlastnictvi || ''),\n      \n      // â•â•â• DRUH A VYUÅ½ITÃ â•â•â•\n      'Druh pozemku': maVymeruRuian ? p_overeno(d.druh_pozemku || '') : p_inzerat(d.druh_pozemku || ''),\n      'ZpÅ¯sob vyuÅ¾itÃ­': maVymeruRuian ? p_overeno(d.zpusob_vyuziti || '') : p_inzerat(d.zpusob_vyuziti || ''),\n      \n// â•â•â• BPEJ â•â•â•\n'BPEJ kÃ³d': d.bpej_kod === 'NEMÃ (nenÃ­ ZPF)' \n  ? 'â—‰ NEMÃ (nenÃ­ ZPF)' \n  : (maBpej ? p_overeno(d.bpej_kod) : 'âœ— NENÃ V LPIS'),\n'TÅ™Ã­da ZPF': d.bpej_kod === 'NEMÃ (nenÃ­ ZPF)' \n  ? 'â—‰ -' \n  : (maBpej ? p_overeno(d.trida_zpf || '') : 'âœ— -'),\n'BPEJ sklon': d.bpej_kod === 'NEMÃ (nenÃ­ ZPF)' \n  ? 'â—‰ -' \n  : (maBpej ? p_overeno(d.bpej_sklonitost || '') : 'âœ— -'),\n'BPEJ expozice': d.bpej_kod === 'NEMÃ (nenÃ­ ZPF)' \n  ? 'â—‰ -' \n  : (maBpej ? p_overeno(d.bpej_orientace || '') : 'âœ— -'),\n'Popis pÅ¯dy': d.bpej_kod === 'NEMÃ (nenÃ­ ZPF)' \n  ? 'â—‰ -' \n  : (maBpej ? p_overeno(d.popis_pudy || '') : 'âœ— -'),\n      \n      // â•â•â• FVE POTENCIÃL â•â•â•\n      'FVE vÃ½roba [kWh/kWp]': maFve ? p_overeno(d.fve_rocni_vyroba_kwh_kwp) : 'âœ— -',\n      'FVE ozÃ¡Å™enÃ­ [kWh/mÂ²]': maFve ? p_overeno(d.fve_rocni_ozareni_kwh_m2 || '') : 'âœ— -',\n      'FVE sklon [Â°]': maFve ? p_overeno(d.fve_optimalny_sklon || '') : 'âœ— -',\n      'FVE azimut [Â°]': maFve ? p_overeno(d.fve_optimalny_azimut || '') : 'âœ— -',\n      \n      // â•â•â• RATINGY (AI) â•â•â•\n      'Rating STAVEBNÃ': p_ai(ratingStavebni),\n      'Verdikt STAVEBNÃ': p_ai(getVerdikt(ratingStavebni)),\n      'Rating FVE': p_ai(ratingFve),\n      'Verdikt FVE': p_ai(getVerdikt(ratingFve)),\n      'Rating MVE': p_ai(ratingMve),\n      'Verdikt MVE': p_ai(getVerdikt(ratingMve)),\n      \n      // â•â•â• DOPORUÄŒENÃ (AI) â•â•â•\n      'DoporuÄenÃ© vyuÅ¾itÃ­': p_ai(d.doporucene_vyuziti || ''),\n      'HlavnÃ­ vÃ½hoda': p_ai(d.hlavni_vyhoda || ''),\n      'HlavnÃ­ bariÃ©ra': p_ai(d.hlavni_bariera || ''),\n      'AnalÃ½za': p_ai(d.analyza_text || ''),\n      \n      // â•â•â• POPIS (z inzerÃ¡tu, bez prefixu - pÅ™Ã­liÅ¡ dlouhÃ½) â•â•â•\n      'Popis inzerÃ¡tu': zkratPopis(d.popis_text || loopItem.popis_text || ''),\n      \n      // â•â•â• METADATA â•â•â•\n      'Datum': new Date().toISOString().split('T')[0],\n      'ÄŒas': new Date().toISOString().split('T')[1].split('.')[0]\n    }\n  };\n});"
      },
      "id": "31743b63-0fda-4412-9264-7d56be99c80b",
      "name": "ğŸ“Š VÃ½stupnÃ­ Parser",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -272,
        576
      ]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// SREALITY PARSER - FÃZE 1\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst items = $input.all();\nlet config = {};\n\ntry {\n  const loopData = $('ğŸ”„ Sreality Loop').item.json;\n  config = loopData.config || {};\n} catch (e) {\n  console.log('Config z loop nenalezen');\n}\n\nconst results = [];\n\n// KATEGORIE MAP - klÃ­Äe jako ÄÃ­sla\nconst KATEGORIE_MAP = {\n  19: 'BydlenÃ­',\n  20: 'KomerÄnÃ­',\n  21: 'Pole',\n  22: 'Louky',\n  23: 'Zahrady',\n  24: 'Lesy',\n  25: 'RybnÃ­ky',\n  26: 'Sady',\n  27: 'OstatnÃ­'\n};\n\nfor (const item of items) {\n  const data = item.json;\n  const estates = data._embedded?.estates || data.estates || [];\n  \n  if (!Array.isArray(estates)) continue;\n  \n  // Debug prvnÃ­ho estate\n  if (estates.length > 0 && results.length === 0) {\n    const first = estates[0];\n    const seoSubCb = first.seo?.category_sub_cb;\n    console.log(`DEBUG: seo.category_sub_cb = ${seoSubCb} (type: ${typeof seoSubCb})`);\n    console.log(`DEBUG: KATEGORIE_MAP[${seoSubCb}] = ${KATEGORIE_MAP[seoSubCb]}`);\n    console.log(`DEBUG: KATEGORIE_MAP[parseInt(${seoSubCb})] = ${KATEGORIE_MAP[parseInt(seoSubCb)]}`);\n  }\n  \n  let skipped = 0;\n  for (const estate of estates) {\n    // ZÃ­skat hash_id z rÅ¯znÃ½ch zdrojÅ¯\n    let hashId = estate.hash_id || estate.id;\n    \n    // Zkusit extrahovat z _links.self.href (napÅ™. \"/estates/1234567\")\n    if (!hashId && estate._links?.self?.href) {\n      const match = estate._links.self.href.match(/\\/(\\d+)$/);\n      if (match) {\n        hashId = parseInt(match[1]);\n        console.log('â„¹ï¸ ID z _links:', hashId);\n      }\n    }\n    \n    // Zkusit z URI\n    if (!hashId && estate.uri) {\n      const match = estate.uri.match(/\\/(\\d+)$/);\n      if (match) {\n        hashId = parseInt(match[1]);\n        console.log('â„¹ï¸ ID z uri:', hashId);\n      }\n    }\n    \n    // Pokud stÃ¡le nemÃ¡me ID, vyÅ™adit (potÅ™ebujeme ho pro Detail API)\n    if (!hashId) {\n      console.log('âš ï¸ VyÅ™azeno - bez hash_id:', estate.name?.substring(0, 40));\n      skipped++;\n      continue;\n    }\n    \n    // â•â•â• CENA â•â•â•\n    let cena = 0;\n    let cenaDuvod = '';\n    \n    if (estate.price_czk?.value_raw) {\n      cena = estate.price_czk.value_raw;\n    } else if (estate.price_czk?.value) {\n      cena = estate.price_czk.value;\n    } else if (typeof estate.price === 'number' && estate.price > 0) {\n      cena = estate.price;\n    }\n    \n    const name = estate.name || '';\n    const priceName = estate.price_czk?.name || '';\n    \n    if (name.toLowerCase().includes('info o cenÄ›') || \n        priceName.toLowerCase().includes('info o cenÄ›')) {\n      cenaDuvod = 'Cena na vyÅ¾Ã¡dÃ¡nÃ­';\n      cena = 0;\n    }\n    \n    // â•â•â• KATEGORIE - OPRAVA: parseInt pro jistotu! â•â•â•\n    const kategorieKodRaw = estate.seo?.category_sub_cb;\n    const kategorieKod = parseInt(kategorieKodRaw) || 0;\n    const kategorieNazev = KATEGORIE_MAP[kategorieKod] || 'OstatnÃ­';\n    \n    const hasRealId = typeof hashId === 'number' || (typeof hashId === 'string' && !hashId.startsWith('gen_'));\n    \n    results.push({\n      json: {\n        hash_id: hashId,\n        has_real_id: hasRealId,\n        cena: cena,\n        cena_duvod: cenaDuvod,\n        nazev: name,\n        lokalita: estate.locality || '',\n        kategorie_kod: kategorieKod,\n        kategorie: kategorieNazev,\n        config: config\n      }\n    });\n  }\n}\n\n// Statistika kategoriÃ­\nconst kategorieStat = {};\nresults.forEach(r => {\n  const k = r.json.kategorie || 'PRÃZDNÃ';\n  kategorieStat[k] = (kategorieStat[k] || 0) + 1;\n});\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\nconsole.log('FÃZE 1 VÃSLEDEK:');\nconsole.log('  ZpracovÃ¡no:', results.length);\nconsole.log('  Kategorie:', JSON.stringify(kategorieStat));\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n\nif (results.length === 0) {\n  return [{ json: { _empty: true, config: config } }];\n}\n\nreturn results;"
      },
      "id": "6a686bd4-6d17-4804-a691-16b6e6892c30",
      "name": "ğŸ  Sreality FÃ¡ze 1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2192,
        1280
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {},
      "id": "16b9911e-c8b4-4707-9528-3287505196a1",
      "name": "ğŸ  Next Lista",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -1744,
        1344
      ]
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 24
            }
          ]
        }
      },
      "id": "640ed6e5-bed1-4e79-a724-1a1c31673aa6",
      "name": "â° DennÃ­",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -3312,
        1152
      ]
    },
    {
      "parameters": {
        "path": "086bc45b-8bd7-4598-931e-85f884f67157",
        "formTitle": "ğŸï¸ PozemkovÃ½ Agent v51",
        "formDescription": "AutomatickÃ¡ analÃ½za investiÄnÃ­ch pozemkÅ¯",
        "formFields": {
          "values": [
            {
              "fieldLabel": "ğŸ’° Max cena (KÄ)",
              "fieldType": "number",
              "placeholder": "2000000",
              "requiredField": true
            },
            {
              "fieldLabel": "ğŸ“ Min vÃ½mÄ›ra (mÂ²)",
              "fieldType": "number",
              "placeholder": "500"
            },
            {
              "fieldLabel": "ğŸ“„ Max strÃ¡nek",
              "fieldType": "number",
              "placeholder": "3",
              "requiredField": true
            },
            {
              "fieldLabel": "ğŸ”˜ Sreality",
              "fieldType": "checkbox",
              "defaultValue": "true",
              "fieldOptions": {
                "values": [
                  {}
                ]
              }
            },
            {
              "fieldLabel": "ğŸ’° Pouze s cenou",
              "fieldType": "checkbox",
              "defaultValue": "true",
              "fieldOptions": {
                "values": [
                  {}
                ]
              }
            },
            {
              "fieldLabel": "ğŸš« Vynechat podÃ­ly",
              "fieldType": "checkbox",
              "defaultValue": "true",
              "fieldOptions": {
                "values": [
                  {}
                ]
              }
            },
            {
              "fieldLabel": "âš ï¸ Vynechat exekuce/draÅ¾by",
              "fieldType": "checkbox",
              "defaultValue": "true",
              "fieldOptions": {
                "values": [
                  {}
                ]
              }
            },
            {
              "fieldLabel": "ğŸï¸ Typy pozemkÅ¯",
              "fieldType": "dropdown",
              "fieldOptions": {
                "values": [
                  {
                    "option": "OrnÃ¡ pÅ¯da"
                  },
                  {
                    "option": "Louka/TTP"
                  },
                  {
                    "option": "Zahrada"
                  },
                  {
                    "option": "StavebnÃ­"
                  },
                  {
                    "option": "Les"
                  },
                  {
                    "option": "OstatnÃ­"
                  }
                ]
              },
              "multiselect": true
            }
          ]
        },
        "options": {}
      },
      "id": "6dcf7fc4-6c3f-415d-b141-345c2a3cd400",
      "name": "ğŸ“‹ FormulÃ¡Å™",
      "type": "n8n-nodes-base.formTrigger",
      "typeVersion": 2.1,
      "position": [
        -3312,
        1344
      ],
      "webhookId": "086bc45b-8bd7-4598-931e-85f884f67157"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// KONFIGURACE v63 - OPRAVENÃ DETEKCE CHECKBOXÅ®\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst input = $input.first().json;\n\n// DEBUG - raw hodnoty z formulÃ¡Å™e\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\nconsole.log('RAW INPUT Z FORMULÃÅ˜E:');\nconsole.log('  VÅ¡echny klÃ­Äe:', Object.keys(input));\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// POMOCNÃ‰ FUNKCE\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nfunction isChecked(name) {\n    const val = input[name];\n    \n    // PrÃ¡zdnÃ© hodnoty = nezaÅ¡krtnuto\n    if (val === undefined || val === null || val === false || val === '') return false;\n    if (val === 'false' || val === '0' || val === 0) return false;\n    \n    // PrÃ¡zdnÃ½ objekt {} nebo pole [] = nezaÅ¡krtnuto\n    if (typeof val === 'object') {\n      if (Array.isArray(val)) return val.length > 0;\n      return Object.keys(val).length > 0;  // {} mÃ¡ 0 klÃ­ÄÅ¯ = false\n    }\n    \n    // ZaÅ¡krtnuto\n    if (val === true || val === 'true' || val === 1 || val === '1') return true;\n    if (val === 'on' || val === 'yes') return true;\n    \n    return false;\n}\n\nfunction getNum(name, defaultVal) {\n    let val = input[name];\n    if (typeof val === 'string') {\n        val = val.replace(/[\\s,]/g, '').replace(/\\./g, '');\n    }\n    const num = parseInt(val);\n    return isNaN(num) ? defaultVal : num;\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// TYPY POZEMKÅ®\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nlet typyPozemku = input['ğŸï¸ Typy pozemkÅ¯'] || [];\n\nif (typeof typyPozemku === 'string') {\n    typyPozemku = typyPozemku ? [typyPozemku] : [];\n}\n\nif (!typyPozemku || typyPozemku.length === 0) {\n    typyPozemku = ['OrnÃ¡ pÅ¯da', 'Louka/TTP', 'Zahrada', 'StavebnÃ­', 'Les', 'OstatnÃ­'];\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// SESTAVENÃ CONFIGU\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst config = {\n    cena_max: getNum('ğŸ’° Max cena (KÄ)', 999999999),\n    cena_min: 1001,\n    vymera_min: getNum('ğŸ“ Min vÃ½mÄ›ra (mÂ²)', 0),\n    max_pages: getNum('ğŸ“„ Max strÃ¡nek', 3),\n    \n    servery: { sreality: true },\n    \n    pouze_s_cenou: isChecked('ğŸ’° Pouze s cenou'),\n    vynechat_podily: isChecked('ğŸš« Vynechat podÃ­ly'),\n    vynechat_exekuce: isChecked('âš ï¸ Vynechat exekuce/draÅ¾by'),\n    \n    typy_pozemku: typyPozemku\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DEBUG\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconsole.log('KONFIGURACE v63:');\nconsole.log('  Max cena:', config.cena_max);\nconsole.log('  Pouze s cenou:', config.pouze_s_cenou ? 'âœ…' : 'âŒ');\nconsole.log('  Vynechat podÃ­ly:', config.vynechat_podily ? 'âœ…' : 'âŒ');\nconsole.log('  Vynechat exekuce:', config.vynechat_exekuce ? 'âœ…' : 'âŒ');\n\nreturn [{ json: config }];"
      },
      "id": "f89b15e3-a7f4-49bc-adfc-f85b858575c4",
      "name": "âš™ï¸ Konfigurace",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3088,
        1280
      ]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// SREALITY URLs\n// VeÅ¡kerÃ© filtrovÃ¡nÃ­ se dÄ›lÃ¡ LOKÃLNÄš v Pre-Filtru\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst config = $input.first().json;\n\n// URL BEZ jakÃ½chkoliv filtrÅ¯ - stÃ¡hne VÅ ECHNY pozemky\n// category_main_cb=3 = pozemky\n// category_type_cb=1 = prodej\nconst baseUrl = 'https://www.sreality.cz/api/cs/v2/estates?category_main_cb=3&category_type_cb=1&per_page=60';\n\nconst urls = [];\nfor (let page = 1; page <= config.max_pages; page++) {\n  urls.push({\n    page: page,\n    url: baseUrl + '&page=' + page,\n    config: config\n  });\n}\n\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\nconsole.log('SREALITY URLs v60:');\nconsole.log('  StrÃ¡nek:', config.max_pages);\nconsole.log('  URL:', urls[0]?.url);\nconsole.log('  (CenovÃ½ filtr je v Pre-Filtru, NE v URL)');\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n\nreturn urls.map(u => ({ json: u }));"
      },
      "id": "ff4c63a2-39cd-4609-80cb-a2c105e404a6",
      "name": "ğŸ  Sreality URLs",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2864,
        1280
      ]
    },
    {
      "parameters": {
        "options": {
          "reset": false
        }
      },
      "id": "65948bcf-9e0c-4743-99b2-2b81a8f0bcee",
      "name": "ğŸ”„ Sreality Loop",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -2640,
        1280
      ]
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          },
          "timeout": 60000
        }
      },
      "id": "64d2ce48-a5cd-46cb-8904-3671c833b347",
      "name": "ğŸ  Sreality HTTP",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2416,
        1280
      ],
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// PRE-FILTR\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst items = $input.all();\nconst results = [];\n\n// NaÄÃ­st config\nlet cfg = {};\ntry {\n  cfg = $('âš™ï¸ Konfigurace').first().json;\n} catch (e) {\n  cfg = items[0]?.json?.config || {};\n}\n\n// Konfigurace\nconst maxCena = cfg.cena_max || 999999999;\nconst minCena = cfg.cena_min || 1001;  // ÄŒte z configu, default 1001\nconst pouzeSCenou = cfg.pouze_s_cenou === true;\nconst vynechatPodily = cfg.vynechat_podily === true;\nconst vynechatExekuce = cfg.vynechat_exekuce === true;\nconst typyPozemku = cfg.typy_pozemku || [];\n\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\nconsole.log('PRE-FILTR v4:');\nconsole.log('  Vstup:', items.length);\nconsole.log('  Min cena:', minCena, 'KÄ');\nconsole.log('  Max cena:', maxCena === 999999999 ? 'BEZ LIMITU' : maxCena.toLocaleString());\nconsole.log('  Pouze s cenou:', pouzeSCenou);\nconsole.log('  Vynechat podÃ­ly:', vynechatPodily);\nconsole.log('  Vynechat exekuce/draÅ¾by:', vynechatExekuce);\nconsole.log('  Typy:', typyPozemku.length === 6 ? 'VÅ ECHNY' : typyPozemku.join(', '));\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n\nlet stats = { celkem: 0, typ: 0, podil: 0, exekuce: 0, bezCeny: 0, nadLimit: 0, podLimit: 0, ok: 0 };\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// POMOCNÃ‰ FUNKCE\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nfunction getTypPozemku(nazev) {\n  const n = (nazev || '').toLowerCase();\n  if (n.includes('stavebnÃ­') || n.includes('k bydlenÃ­')) return 'StavebnÃ­';\n  if (n.includes('pole ') || n.includes('ornÃ©') || n.includes('ornÃ¡')) return 'OrnÃ¡ pÅ¯da';\n  if (n.includes('louk') || n.includes('pastvina') || n.includes('travnÃ­')) return 'Louka/TTP';\n  if (n.includes('zahrad')) return 'Zahrada';\n  if (n.includes('les') || n.includes('lesnÃ­')) return 'Les';\n  if (n.includes('komerÄnÃ­') || n.includes('prÅ¯mysl')) return 'StavebnÃ­';\n  return 'OstatnÃ­';\n}\n\nfunction jePodil(nazev, popis) {\n  const text = ((nazev || '') + ' ' + (popis || '')).toLowerCase();\n  // 100% podÃ­l = OK, nenÃ­ to spoluvlastnictvÃ­\n  if (/100\\s*%/.test(text)) return false;\n  // HledÃ¡me: spoluvlastnictvÃ­, ideÃ¡lnÃ­ podÃ­l, 1/2, 1/4, atd.\n  return text.includes('spoluvlast') || \n         /ideÃ¡lnÃ­.*podÃ­l/.test(text) || \n         /podÃ­l.*ideÃ¡lnÃ­/.test(text) ||\n         /\\d+\\/\\d+/.test(text) ||\n         text.includes('podÃ­l na pozemku');\n}\n\nfunction jeExekuce(nazev, popis) {\n  const text = ((nazev || '') + ' ' + (popis || '')).toLowerCase();\n  // HledÃ¡me: exekuce, draÅ¾ba, insolvence, nucenÃ½ prodej\n  return text.includes('exekuce') || \n         text.includes('exekuÄ') ||\n         text.includes('draÅ¾ba') || \n         text.includes('draÅ¾eb') ||\n         text.includes('insolvence') || \n         text.includes('insolvenÄ') ||\n         text.includes('nucenÃ½ prodej') ||\n         text.includes('veÅ™ejnÃ¡ soutÄ›Å¾') ||\n         text.includes('konkurz') ||\n         text.includes('likvidace');\n}\n\nfunction jeSymbolickaCena(cena, nazev) {\n  // Cena <= 1000 = symbolickÃ¡ (info o cenÄ› u RK)\n  if (cena > 0 && cena <= 1000) return true;\n  const n = (nazev || '').toLowerCase();\n  return n.includes('info o cenÄ›') || \n         n.includes('cena na vyÅ¾Ã¡dÃ¡nÃ­') || \n         n.includes('cena u rk') ||\n         n.includes('cena v rk');\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// HLAVNÃ FILTRAÄŒNÃ SMYÄŒKA\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nfor (const item of items) {\n  const d = item.json;\n  \n  if (!d || d._empty) continue;\n  \n  stats.celkem++;\n  const nazev = d.nazev || '';\n  const popis = d.popis || d.description || '';\n  const cena = d.cena || 0;\n  \n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // 1. TYPOVÃ FILTR\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  if (typyPozemku.length > 0 && typyPozemku.length < 6) {\n    const typ = getTypPozemku(nazev);\n    if (!typyPozemku.includes(typ)) {\n      stats.typ++;\n      continue;\n    }\n  }\n  \n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // 2. FILTR PODÃLÅ® (kontroluje nÃ¡zev I popis)\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  if (vynechatPodily && jePodil(nazev, popis)) {\n    stats.podil++;\n    console.log(`âŒ PodÃ­l: ${nazev.substring(0,50)}`);\n    continue;\n  }\n  \n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // 3. FILTR EXEKUCÃ/DRAÅ½EB (kontroluje nÃ¡zev I popis)\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  if (vynechatExekuce && jeExekuce(nazev, popis)) {\n    stats.exekuce++;\n    console.log(`âŒ Exekuce/draÅ¾ba: ${nazev.substring(0,50)}`);\n    continue;\n  }\n  \n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // 4. FILTR CENY - symbolickÃ© a pod minimem\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  if (pouzeSCenou) {\n    // 4a. Bez ceny nebo symbolickÃ¡ cena\n    if (cena <= 0 || jeSymbolickaCena(cena, nazev)) {\n      stats.bezCeny++;\n      console.log(`âŒ Bez ceny/symbolickÃ¡ (${cena}): ${nazev.substring(0,50)}`);\n      continue;\n    }\n    // 4b. Pod minimÃ¡lnÃ­ reÃ¡lnou cenou\n    if (cena < minCena) {\n      stats.podLimit++;\n      console.log(`âŒ Pod min cenou (${cena} < ${minCena}): ${nazev.substring(0,50)}`);\n      continue;\n    }\n  }\n  \n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // 5. FILTR MAX CENY\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  if (cena > 0 && maxCena < 999999999 && cena > maxCena) {\n    stats.nadLimit++;\n    continue;\n  }\n  \n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // âœ… PROÅ LO VÅ EMI FILTRY\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  stats.ok++;\n  results.push(item);\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// VÃSTUP\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\nconsole.log('VÃSLEDKY:');\nconsole.log('  Celkem:', stats.celkem);\nconsole.log('  VyÅ™azeno typ:', stats.typ);\nconsole.log('  VyÅ™azeno podÃ­l:', stats.podil);\nconsole.log('  VyÅ™azeno exekuce/draÅ¾ba:', stats.exekuce);\nconsole.log('  VyÅ™azeno bez ceny:', stats.bezCeny);\nconsole.log('  VyÅ™azeno pod min cenou:', stats.podLimit);\nconsole.log('  VyÅ™azeno nad max cenou:', stats.nadLimit);\nconsole.log('  âœ… PROÅ LO:', stats.ok);\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n\nif (results.length === 0) {\n  return [{ json: { _no_results: true, _iteration: true } }];\n}\nreturn results;"
      },
      "id": "1dc8a5ee-bf5b-487e-a872-a0a96d0b79e6",
      "name": "ğŸ’° CenovÃ½ Pre-Filtr",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1968,
        1280
      ]
    },
    {
      "parameters": {
        "projectId": {
          "__rl": true,
          "mode": "list",
          "value": "gen-lang-client-0737675877"
        },
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleVertex",
      "typeVersion": 1,
      "position": [
        -624,
        800
      ],
      "id": "e0cb849e-3d9f-4b1e-aeda-cda2e85c465e",
      "name": "Gemini 2.5 Flash",
      "retryOnFail": true,
      "waitBetweenTries": 3000,
      "maxTries": 2,
      "credentials": {
        "googleApi": {
          "id": "KGzAAuQ37otupHhs",
          "name": "Google Service Account account"
        }
      }
    },
    {
      "parameters": {},
      "id": "be973f78-dbe6-4568-bcad-ca9dc0d61930",
      "name": "â¡ï¸ Next Pozemek",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        176,
        688
      ]
    },
    {
      "parameters": {},
      "id": "5b25fe98-71ed-4bfb-8029-4a7fd780025f",
      "name": "ğŸ“­ Å½Ã¡dnÃ© k analÃ½ze",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -848,
        768
      ]
    },
    {
      "parameters": {
        "options": {
          "reset": false
        }
      },
      "id": "009ae284-b557-4836-9e64-e897610ecd3f",
      "name": "ğŸ”„ Pozemek Loop",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -848,
        432
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "has-items",
              "leftValue": "={{ $json._empty }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "f0c88998-1b0b-4d50-a0bf-703c3e2fb80f",
      "name": "â“ Jsou pozemky?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1072,
        608
      ]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst seen = new Set();\nconst results = [];\n\nfor (const item of items) {\n  const d = item.json;\n  if (!d || d._empty) continue;\n  \n  const hashId = d.hash_id;\n  if (!hashId) continue;\n  if (seen.has(hashId)) continue;\n  seen.add(hashId);\n  \n  results.push(item);\n}\n\nconsole.log(`Hash SbÄ›raÄ: ${items.length} -> ${results.length} unikÃ¡tnÃ­ch`);\nif (results.length === 0) {\n  return [{ json: { _empty: true, _server: 'sreality' } }];\n}\nreturn results;"
      },
      "id": "e9370424-bb91-4807-be9e-4bad08dc4919",
      "name": "ğŸ“¦ Hash SbÄ›raÄ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2416,
        1088
      ]
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1b2WRbLg8eI2l7xTT6qhtKXTevi9FjnOLyAmx80Zy9WI",
          "mode": "list",
          "cachedResultName": "PozemkovÃ½ agent",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1b2WRbLg8eI2l7xTT6qhtKXTevi9FjnOLyAmx80Zy9WI/edit"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "HlavnÃ­ pÅ™ehled"
        },
        "options": {}
      },
      "id": "c21aa5d4-1bb1-498e-8ba2-be81f42687b9",
      "name": "ğŸ“Š NaÄÃ­st Sheet",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -1968,
        1088
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "RAU9mUN1AEbXa8XU",
          "name": "Google Sheets account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// NAJÃT NOVÃ‰\nlet sheetData = [];\ntry {\n  sheetData = $input.all().filter(i => i.json && !i.json._empty);\n} catch (e) {}\n\nlet filtered = [];\ntry {\n  filtered = $('ğŸ“¦ Filtr + Dedup').all().filter(i => i.json && !i.json._empty);\n} catch (e) {}\n\nif (filtered.length === 0) {\n  return [{ json: { _empty: true, _reason: 'no_scraped_data' } }];\n}\n\nconst existingKeys = new Set();\nfor (const item of sheetData) {\n  const j = item.json;\n  if (j.ID) existingKeys.add(j.ID);\n  if (j.hash_id) existingKeys.add(`sr_${j.hash_id}`);\n  if (j.Odkaz) existingKeys.add(j.Odkaz);\n  if (j['ID [hash]']) existingKeys.add(j['ID [hash]']);\n}\n\nconst newItems = [];\nfor (const item of filtered) {\n  const j = item.json;\n  if (!j || j._empty) continue;\n  const key = j.dedup_key || (j.hash_id ? `sr_${j.hash_id}` : j.url);\n  if (key && existingKeys.has(key)) continue;\n  if (j.url && existingKeys.has(j.url)) continue;\n  newItems.push({ json: j });\n}\n\nreturn newItems.length > 0 ? newItems : [{ json: { _empty: true, _reason: 'no_new_items' } }];"
      },
      "id": "ea695a05-69ab-4740-8906-ff7feaaf6346",
      "name": "ğŸ†• NajÃ­t NovÃ©",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1744,
        1088
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "has-new",
              "leftValue": "={{ $json._empty }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "268f2441-07c7-4f5e-b2fa-f27e0496f899",
      "name": "â“ Jsou novÃ©?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -1520,
        1088
      ]
    },
    {
      "parameters": {},
      "id": "276a5ab8-fb62-4a49-80c4-f8481e6341b3",
      "name": "ğŸ“­ Å½Ã¡dnÃ© novÃ©",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -1296,
        1088
      ]
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1b2WRbLg8eI2l7xTT6qhtKXTevi9FjnOLyAmx80Zy9WI",
          "mode": "list",
          "cachedResultName": "PozemkovÃ½ agent"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "HlavnÃ­ pÅ™ehled"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {},
          "matchingColumns": [
            "_empty"
          ],
          "schema": [
            {
              "id": "_empty",
              "displayName": "_empty",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "4fda94d7-f4a4-4802-b315-0f01227c7ce9",
      "name": "ğŸ“ Zapsat Sheet",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -48,
        576
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "RAU9mUN1AEbXa8XU",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {},
      "id": "acd209b1-7ecb-43de-8ec6-908cbd877797",
      "name": "âœ… Hotovo",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -560,
        272
      ]
    },
    {
      "parameters": {
        "jsCode": "// FILTR + DEDUP\nconst items = $input.all();\nconst seen = new Set();\nconst results = [];\n\nlet minVymera = 0;\ntry {\n  const cfg = $('âš™ï¸ Konfigurace').first().json;\n  minVymera = cfg.vymera_min || 0;\n} catch (e) {}\n\nfor (const item of items) {\n  const d = item.json;\n  if (!d || d._empty || d._error) continue;\n  const key = d.dedup_key || d.url || d.hash_id;\n  if (key && seen.has(key)) continue;\n  if (key) seen.add(key);\n  if (minVymera > 0) {\n    const vymera = d.vymera_m2 || d.vymera || 0;\n    if (vymera > 0 && vymera < minVymera) continue;\n  }\n  results.push(item);\n}\n\nreturn results.length > 0 ? results : [{ json: { _empty: true } }];"
      },
      "id": "eba34e3c-6e7c-4464-a47f-cc7ae8f168f7",
      "name": "ğŸ“¦ Filtr + Dedup",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2192,
        1088
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "ğŸ“ Parcela GPS Extractor": {
      "main": [
        [
          {
            "node": "ğŸŒ¾ BPEJ HTTP",
            "type": "main",
            "index": 0
          },
          {
            "node": "â˜€ï¸ PVGIS HTTP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PÅ™Ã­prava pro API": {
      "main": [
        [
          {
            "node": "ğŸ—ºï¸ RÃšIAN KÃš HTTP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â³ API Pauza": {
      "main": [
        [
          {
            "node": "ğŸ  Sreality fÃ¡ze 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š Data Aggregator": {
      "main": [
        [
          {
            "node": "ğŸ  Next Detail",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”„ Sreality Detail Loop": {
      "main": [
        [
          {
            "node": "â“ Jsou pozemky?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ  Sreality Detail HTTP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ  Sreality Detail HTTP": {
      "main": [
        [
          {
            "node": "â³ API Pauza",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ  Sreality fÃ¡ze 2": {
      "main": [
        [
          {
            "node": "PÅ™Ã­prava pro API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ  Next Detail": {
      "main": [
        [
          {
            "node": "ğŸ”„ Sreality Detail Loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸŒ¾ BPEJ HTTP": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ—ºï¸ RÃšIAN Parcely HTTP": {
      "main": [
        [
          {
            "node": "ğŸ“ Parcela GPS Extractor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP_API_Tool": {
      "ai_tool": [
        [
          {
            "node": "ğŸï¸ PozemkovÃ½ Analytik v6",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "ğŸ“Š Data Aggregator",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â˜€ï¸ PVGIS HTTP": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "ğŸ—ºï¸ RÃšIAN KÃš HTTP": {
      "main": [
        [
          {
            "node": "ğŸ—ºï¸ RÃšIAN Parcely HTTP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸï¸ PozemkovÃ½ Analytik v6": {
      "main": [
        [
          {
            "node": "ğŸ“Š VÃ½stupnÃ­ Parser",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ  Sreality FÃ¡ze 1": {
      "main": [
        [
          {
            "node": "ğŸ’° CenovÃ½ Pre-Filtr",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ  Next Lista": {
      "main": [
        [
          {
            "node": "ğŸ”„ Sreality Loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â° DennÃ­": {
      "main": [
        [
          {
            "node": "âš™ï¸ Konfigurace",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‹ FormulÃ¡Å™": {
      "main": [
        [
          {
            "node": "âš™ï¸ Konfigurace",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âš™ï¸ Konfigurace": {
      "main": [
        [
          {
            "node": "ğŸ  Sreality URLs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ  Sreality URLs": {
      "main": [
        [
          {
            "node": "ğŸ”„ Sreality Loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”„ Sreality Loop": {
      "main": [
        [
          {
            "node": "ğŸ“¦ Hash SbÄ›raÄ",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ  Sreality HTTP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ  Sreality HTTP": {
      "main": [
        [
          {
            "node": "ğŸ  Sreality FÃ¡ze 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’° CenovÃ½ Pre-Filtr": {
      "main": [
        [
          {
            "node": "ğŸ  Next Lista",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini 2.5 Flash": {
      "ai_languageModel": [
        [
          {
            "node": "ğŸï¸ PozemkovÃ½ Analytik v6",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š VÃ½stupnÃ­ Parser": {
      "main": [
        [
          {
            "node": "ğŸ“ Zapsat Sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â¡ï¸ Next Pozemek": {
      "main": [
        [
          {
            "node": "ğŸ”„ Pozemek Loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”„ Pozemek Loop": {
      "main": [
        [
          {
            "node": "âœ… Hotovo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸï¸ PozemkovÃ½ Analytik v6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â“ Jsou pozemky?": {
      "main": [
        [
          {
            "node": "ğŸ”„ Pozemek Loop",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ“­ Å½Ã¡dnÃ© k analÃ½ze",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¦ Hash SbÄ›raÄ": {
      "main": [
        [
          {
            "node": "ğŸ“¦ Filtr + Dedup",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š NaÄÃ­st Sheet": {
      "main": [
        [
          {
            "node": "ğŸ†• NajÃ­t NovÃ©",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ†• NajÃ­t NovÃ©": {
      "main": [
        [
          {
            "node": "â“ Jsou novÃ©?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â“ Jsou novÃ©?": {
      "main": [
        [
          {
            "node": "ğŸ”„ Sreality Detail Loop",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ“­ Å½Ã¡dnÃ© novÃ©",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ Zapsat Sheet": {
      "main": [
        [
          {
            "node": "â¡ï¸ Next Pozemek",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¦ Filtr + Dedup": {
      "main": [
        [
          {
            "node": "ğŸ“Š NaÄÃ­st Sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "788ef79a-40c1-41ac-87d6-a0d7a07a74a1",
  "meta": {
    "instanceId": "8e34adb2300e52401f1c93ba0ab7517532d8d52d13b15ba3aac6a6f9125919c4"
  },
  "id": "lqt1iCX6EMmtWwqm",
  "tags": []
}